<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Admin Panel</title>
  <link rel="stylesheet" href="/admin.css">
</head>
  
<body>
  <!-- Sidebar overlay for mobile -->
  <div class="sidebar-overlay" id="sidebarOverlay" onclick="closeMobileMenu()"></div>

  <div class="admin-layout">
    <!-- Sidebar Navigation -->
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <h2>üìö Admin Panel</h2>
      </div>
      <nav>
        <a class="nav-item active" onclick="showSection('dashboard')" data-section="dashboard">
          <span class="icon">üìä</span>
          Dashboard
        </a>
        
        <!-- FLASHCARDS SECTION -->
        <div class="nav-section-group">
          <div class="nav-section-label">FLASHCARDS</div>
          <a class="nav-item" onclick="showSection('chapters')" data-section="chapters">
            <span class="icon">üìö</span>
            Chapters
          </a>
          <a class="nav-item" onclick="showSection('topics')" data-section="topics">
            <span class="icon">üìù</span>
            Topics
          </a>
          <a class="nav-item" onclick="showSection('flashcards')" data-section="flashcards">
            <span class="icon">üé¥</span>
            All Flashcards
          </a>
          <a class="nav-item" onclick="showSection('add-content')" data-section="add-content">
            <span class="icon">‚ûï</span>
            Add Flashcard
          </a>
          <a class="nav-item" onclick="showSection('bulk-upload')" data-section="bulk-upload">
            <span class="icon">üì¶</span>
            Bulk Upload
          </a>
        </div>

        <!-- NOTES SECTION -->
        <div class="nav-section-group" style="border-left: 2px solid rgba(255,215,0,0.2);">
          <div class="nav-section-label" style="color: #ffd700;">NOTES</div>
          <a class="nav-item" onclick="showSection('notes')" data-section="notes">
            <span class="icon">üìù</span>
            All Notes
          </a>
          <a class="nav-item" onclick="showSection('add-note')" data-section="add-note">
            <span class="icon">‚ûï</span>
            Add Note
          </a>
        </div>

        <a class="nav-item" onclick="showSection('premium')" data-section="premium">
          <span class="icon">‚≠ê</span>
          Premium Management
        </a>
        <a class="nav-item" onclick="showSection('users')" data-section="users">
          <span class="icon">üë•</span>
          Users
        </a>
        <a class="nav-item" onclick="showSection('device-locks')" data-section="device-locks">
          <span class="icon">üîí</span>
          Device Locks
        </a>
      </nav>
      <div class="sidebar-footer">
        <a href="/" class="home-btn" style="width: 100%; text-align: center; display: block; margin-bottom: 12px;">‚Üê Back to Home</a>
        <form action="/logout" method="GET">
          <button type="submit" class="danger" style="width: 100%;">Logout</button>
        </form>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
      <!-- Search Bar -->
      <div class="search-section">
        <div class="search-bar">
          <input type="text" class="search-input" id="globalSearch" placeholder="üîç Search chapters, topics, flashcards, or notes..." oninput="performSearch()">
          <button onclick="clearSearch()">Clear</button>
        </div>
      </div>

      <!-- Dashboard Section -->
      <div class="section active" id="dashboard-section">
        <div style="max-width: 1200px; margin: 0 auto;">
          <h1 class="title">Dashboard</h1>
          
          <div class="stats-grid">
            <div class="stat-card">
              <div class="icon">üìö</div>
              <div class="number" id="stat-chapters"><%= chapters.length %></div>
              <div class="label">Flashcard Chapters</div>
            </div>
            <div class="stat-card">
              <div class="icon">üìù</div>
              <div class="number" id="stat-topics"><%= topics.length %></div>
              <div class="label">Flashcard Topics</div>
            </div>
            <div class="stat-card">
              <div class="icon">üé¥</div>
              <div class="number" id="stat-flashcards"><span class="loading"></span></div>
              <div class="label">Total Flashcards</div>
            </div>
            <div class="stat-card" style="background: rgba(255,215,0,0.08); border-color: rgba(255,215,0,0.2);">
              <div class="icon">üìù</div>
              <div class="number" id="stat-notes"><%= noteTopics.length %></div>
              <div class="label">Total Notes</div>
            </div>
            <div class="stat-card">
              <div class="icon">üë•</div>
              <div class="number" id="stat-users"><%= users.length %></div>
              <div class="label">Total Users</div>
            </div>
          </div>

          <div class="container">
            <h2>Quick Actions</h2>
            <div class="quick-actions">
              <button onclick="showSection('add-content')">‚ûï Add Flashcard</button>
              <button onclick="showSection('add-note')" style="background: rgba(255,215,0,0.15); border-color: rgba(255,215,0,0.25);">üìù Add Note</button>
              <button onclick="showSection('bulk-upload')">üì¶ Bulk Upload</button>
              <button onclick="showSection('premium')">‚≠ê Manage Premium</button>
              <button onclick="exportAllData()">üì§ Export All Data</button>
              <button onclick="showSection('users')">üë• Manage Users</button>
              <button onclick="showSection('device-locks')" style="background: rgba(255,107,107,0.15); border-color: rgba(255,107,107,0.25);">üîí Device Locks</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Chapters Section -->
      <div class="section" id="chapters-section">
        <div style="max-width: 1200px; margin: 0 auto;">
          <h1 class="title">Chapters Management</h1>
          <div class="container">
            <div class="table-wrapper">
              <table>
                <thead>
                  <tr>
                    <th>Index</th>
                    <th>Name</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  <% chapters.forEach(ch => { %>
                    <tr>
                      <td>Chapter <%= ch._id %></td>
                      <td><%= ch.chapterName %></td>
                      <td>
                        <button onclick="openEditChapterModal(<%= ch._id %>, '<%= ch.chapterName.replace(/'/g, "\\'") %>')">‚úèÔ∏è Edit</button>
                        <button onclick="openDeleteChapterModal(<%= ch._id %>)" class="danger">üóëÔ∏è Delete</button>
                      </td>
                    </tr>
                  <% }) %>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- Topics Section -->
      <div class="section" id="topics-section">
        <div style="max-width: 1200px; margin: 0 auto;">
          <h1 class="title">Topics by Chapter</h1>
          <% 
            let currentChapter = null;
            topics.forEach((tp, index) => {
              if (currentChapter !== tp._id.chapterIndex) {
                if (currentChapter !== null) { 
          %>
                  </ul>
                </div>
              </div>
            <% } %>
            
            <div class="container">
              <div class="collapsible-header" onclick="toggleCollapse(this)">
                <h2>Chapter <%= tp._id.chapterIndex %>: <%= tp.chapterName %></h2>
                <span class="collapse-icon">‚ñº</span>
              </div>
              <div class="collapsible-content">
                <ul class="topic-list">
          <%
                currentChapter = tp._id.chapterIndex;
              } 
          %>
                  <li class="topic-item">
                    <div>
                      <strong>Topic <%= tp._id.topicIndex %>: <%= tp.topicName %></strong>
                      <span class="card-count" id="count-<%= tp._id.chapterIndex %>-<%= tp._id.topicIndex %>">...</span>
                    </div>
                    <div>
                      <button onclick="viewFlashcards(<%= tp._id.chapterIndex %>, <%= tp._id.topicIndex %>, '<%= tp.topicName.replace(/'/g, "\\'") %>')">üìã View</button>
                      <button onclick="openTopicEditModal('<%= tp._id.chapterIndex %>', '<%= tp._id.topicIndex %>', '<%= tp.topicName.replace(/'/g, "\\'") %>')">‚úèÔ∏è Edit</button>
                      <button onclick="openDeleteTopicModal('<%= tp._id.chapterIndex %>', '<%= tp._id.topicIndex %>', '<%= tp.topicName.replace(/'/g, "\\'") %>')" class="danger">üóëÔ∏è Del</button>
                    </div>
                  </li>
          <% 
              if (index === topics.length - 1) { 
          %>
                </ul>
              </div>
            </div>
          <% 
              } 
            }) 
          %>
        </div>
      </div>

      <!-- All Flashcards Section -->
      <div class="section" id="flashcards-section">
        <div style="max-width: 1200px; margin: 0 auto;">
          <h1 class="title">All Flashcards</h1>
          <div class="container">
            <div class="filter-bar">
              <select id="filterChapter" onchange="filterFlashcards()">
                <option value="">All Chapters</option>
                <% chapters.forEach(ch => { %>
                  <option value="<%= ch._id %>">Ch. <%= ch._id %>: <%= ch.chapterName %></option>
                <% }) %>
              </select>
              <select id="filterTopic" onchange="filterFlashcards()" disabled>
                <option value="">All Topics</option>
              </select>
              <button onclick="loadAllFlashcards()">üîÑ Refresh</button>
            </div>
            <div id="all-flashcards-list">
              <p style="color: #888; text-align: center; padding: 40px;">
                <span class="loading"></span> Loading flashcards...
              </p>
            </div>
          </div>
        </div>
      </div>

      <!-- Add Content Section (Flashcards) -->
      <div class="section" id="add-content-section">
        <div style="max-width: 1200px; margin: 0 auto;">
          <h1 class="title">‚ûï Add Flashcard</h1>
          <div class="container">
            <form action="/admin/add-flashcard" method="POST" id="add-flashcard-form">
              <label>Select Chapter:</label>
              <select id="chapterIndex" name="chapterIndex" onchange="fillChapterName()">
                <option value="">-- Select Chapter --</option>
                <% chapters.forEach(ch => { %>
                  <option value="<%= ch._id %>"><%= ch._id %> ‚Äî <%= ch.chapterName %></option>
                <% }) %>
              </select>
              <input type="text" id="chapterName" name="chapterName" placeholder="Auto-filled chapter name" readonly>

              <label>Or Create New Chapter:</label>
              <input type="text" name="newChapterName" id="newChapterName" placeholder="Enter new chapter name">
              <input type="hidden" name="newChapterIndex" id="newChapterIndex">

              <label>Select Topic:</label>
              <select id="topicIndex" name="topicIndex" onchange="fillTopicName()">
                <option value="">-- Select Topic --</option>
                <% topics.forEach(tp => { %>
                  <option value="<%= tp._id.topicIndex %>" data-chapter="<%= tp._id.chapterIndex %>" data-name="<%= tp.topicName %>">
                    Ch. <%= tp._id.chapterIndex %>, Topic <%= tp._id.topicIndex %> ‚Äî <%= tp.topicName %>
                  </option>
                <% }) %>
              </select>
              <input type="text" id="topicName" name="topicName" placeholder="Auto-filled topic name" readonly>

              <label>Or Create New Topic:</label>
              <div class="form-grid-2">
                <div>
                  <label style="font-size: 12px; color: #888; margin: 0 0 4px 0;">Topic Index:</label>
                  <input type="number" name="newTopicIndex" id="newTopicIndex" min="1" placeholder="Auto" title="Leave empty for auto-numbering or enter a specific number" style="text-align: center; font-weight: 600;">
                </div>
                <div>
                  <label style="font-size: 12px; color: #888; margin: 0 0 4px 0;">Topic Name:</label>
                  <input type="text" name="newTopicName" id="newTopicName" placeholder="Enter new topic name">
                </div>
              </div>
              <small class="info-box">
                üí° <strong>Auto Mode:</strong> Leave index empty for smart numbering (fills gaps)<br>
                üéØ <strong>Manual Mode:</strong> Enter a specific number to create Topic 4, 5, 6, etc.
              </small>

              <label>Question: <span style="color: #ff6b6b;">*</span></label>
              <textarea name="question" required placeholder="Enter the question here"></textarea>
              
              <label>Answer: <span style="color: #ff6b6b;">*</span></label>
              <textarea name="answer" required placeholder="Enter the answer here"></textarea>

              <label style="display: flex; align-items: center; gap: 8px; margin-top: 16px;">
                <input type="checkbox" name="isPremium" id="isPremium" style="width: auto; margin: 0;">
                <span>üîí Mark as Premium Content</span>
              </label>

              <button type="submit" id="submit-flashcard-btn">Add Flashcard</button>
            </form>
          </div>
        </div>
      </div>

      <!-- BULK UPLOAD SECTION -->
      <div class="section" id="bulk-upload-section">
        <div style="max-width: 1200px; margin: 0 auto;">
          <h1 class="title">üì¶ Bulk Upload Flashcards</h1>
          <div class="container">
            <form action="/admin/bulk-upload" method="POST" id="bulk-upload-form" enctype="multipart/form-data">
              <label>Select Chapter:</label>
              <select id="bulkChapterIndex" name="chapterIndex" onchange="fillBulkChapterName()">
                <option value="">-- Select Chapter --</option>
                <% chapters.forEach(ch => { %>
                  <option value="<%= ch._id %>"><%= ch._id %> ‚Äî <%= ch.chapterName %></option>
                <% }) %>
              </select>
              <input type="text" name="chapterName" id="bulkChapterName" readonly placeholder="Auto-filled chapter name">

              <label>Or Create New Chapter:</label>
              <input type="text" name="newChapterName" id="bulknewChapterName" placeholder="Enter new chapter name">
              <input type="hidden" name="newChapterIndex" id="bulknewChapterIndex">

              <label>Select Topic:</label>
              <select id="bulkTopicIndex" name="topicIndex" onchange="fillBulkTopicName()">
                <option value="">-- Select Topic --</option>
                <% topics.forEach(tp => { %>
                  <option value="<%= tp._id.topicIndex %>" data-chapter="<%= tp._id.chapterIndex %>" data-name="<%= tp.topicName %>">
                    Ch. <%= tp._id.chapterIndex %>, Topic <%= tp._id.topicIndex %> ‚Äî <%= tp.topicName %>
                  </option>
                <% }) %>
              </select>
              <input type="text" name="topicName" id="bulkTopicName" readonly placeholder="Auto-filled topic name">

              <label>Or Create New Topic:</label>
              <div class="form-grid-2">
                <div>
                  <label style="font-size: 12px; color: #888; margin: 0 0 4px 0;">Topic Index:</label>
                  <input type="number" name="newTopicIndex" id="bulknewTopicIndex" min="1" placeholder="Auto" title="Leave empty for auto-numbering" style="text-align: center; font-weight: 600;">
                </div>
                <div>
                  <label style="font-size: 12px; color: #888; margin: 0 0 4px 0;">Topic Name:</label>
                  <input type="text" name="newTopicName" id="bulknewTopicName" placeholder="Enter new topic name">
                </div>
              </div>
              <small class="info-box">üí° Leave index empty for smart auto-numbering</small>

              <!-- UPLOAD METHOD TOGGLE -->
              <div class="upload-toggle-container">
                <label style="font-size: 16px; font-weight: 600; margin-bottom: 12px; display: block;">Upload Method:</label>
                <div class="upload-toggle-row">
                  <label class="upload-method-card active" id="bulkFileCard">
                    <input type="radio" name="bulkUploadMethod" value="file" id="bulkMethodFile" checked style="width: auto; margin: 0;">
                    <span style="font-weight: 500;">üìÅ Upload JSON File</span>
                  </label>
                  <label class="upload-method-card" id="bulkTextCard">
                    <input type="radio" name="bulkUploadMethod" value="text" id="bulkMethodText" style="width: auto; margin: 0;">
                    <span style="font-weight: 500;">‚úçÔ∏è Paste JSON Text</span>
                  </label>
                </div>

                <!-- FILE UPLOAD SECTION -->
                <div id="bulkFileUploadSection">
                  <label>Upload JSON File: <span style="color: #ff6b6b;">*</span></label>
                  <input type="file" name="jsonFile" id="bulkJsonFile" accept=".json,application/json" style="padding: 12px; background: rgba(0,0,0,0.3); border: 2px dashed rgba(79,70,229,0.5); cursor: pointer;">
                  <small style="display: block; margin-top: -10px; margin-bottom: 16px; color: #888;">
                    üìÑ Upload a .json file with flashcard data
                  </small>
                  <div id="bulkFilePreview" style="display: none; margin-top: 12px; padding: 12px; background: rgba(0,255,136,0.1); border-left: 3px solid #00ff88; border-radius: 8px;">
                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                      <span style="font-size: 20px;">‚úÖ</span>
                      <strong id="bulkFileName" style="color: #00ff88;"></strong>
                    </div>
                    <small id="bulkFileInfo" style="color: #888;"></small>
                  </div>
                </div>

                <!-- TEXT PASTE SECTION -->
                <div id="bulkTextUploadSection" style="display: none;">
                  <label>Paste JSON Data: <span style="color: #ff6b6b;">*</span></label>
                  <textarea name="jsonData" id="bulkJsonData" placeholder='[{"question": "Q1", "answer": "A1"}, {"question": "Q2", "answer": "A2"}]' style="min-height: 250px; font-family: monospace;"></textarea>
                  <small style="display: block; margin-top: -10px; margin-bottom: 16px; color: #888;">
                    Format: Array of objects with "question" and "answer" keys.
                  </small>
                </div>
              </div>

              <label style="display: flex; align-items: center; gap: 8px; margin-top: 16px;">
                <input type="checkbox" name="isPremium" id="bulkIsPremium" style="width: auto; margin: 0;">
                <span>üîí Mark ALL uploaded flashcards as Premium</span>
              </label>

              <button type="submit" id="bulk-submit-btn">Upload Flashcards</button>
            </form>
          </div>
        </div>
      </div>

      <!-- All Notes Section -->
      <div class="section" id="notes-section">
        <div style="max-width: 1200px; margin: 0 auto;">
          <h1 class="title">üìù All Notes</h1>
          <div class="container">
            <div class="filter-bar">
              <select id="filterNoteChapter" onchange="filterNotes()">
                <option value="">All Chapters</option>
                <% noteChapters.forEach(ch => { %>
                  <option value="<%= ch._id %>">Ch. <%= ch._id %>: <%= ch.chapterName %></option>
                <% }) %>
              </select>
              <button onclick="loadAllNotes()">üîÑ Refresh</button>
            </div>
            <div id="all-notes-list">
              <p style="color: #888; text-align: center; padding: 40px;">
                <span class="loading"></span> Loading notes...
              </p>
            </div>
          </div>
        </div>
      </div>

      <!-- ADD NOTE SECTION -->
      <div class="section" id="add-note-section">
        <div style="max-width: 1200px; margin: 0 auto;">
          <h1 class="title">üìù Add New Note</h1>
          <div class="container">
            <form action="/admin/add-note" method="POST" id="add-note-form" enctype="multipart/form-data">
              <label>Select Chapter:</label>
              <select id="noteChapterIndex" name="chapterIndex" onchange="fillNoteChapterName()">
                <option value="">-- Select Chapter --</option>
                <% noteChapters.forEach(ch => { %>
                  <option value="<%= ch._id %>"><%= ch._id %> ‚Äî <%= ch.chapterName %></option>
                <% }) %>
              </select>
              <input type="text" id="noteChapterName" name="chapterName" placeholder="Auto-filled chapter name" readonly>

              <label>Or Create New Chapter:</label>
              <input type="text" name="newChapterName" id="noteNewChapterName" placeholder="Enter new chapter name">
              <input type="hidden" name="newChapterIndex" id="noteNewChapterIndex">

              <label>Select Topic:</label>
              <select id="noteTopicIndex" name="topicIndex" onchange="fillNoteTopicName()">
                <option value="">-- Select Topic --</option>
                <% noteTopics.forEach(tp => { %>
                  <option value="<%= tp._id.topicIndex %>" data-chapter="<%= tp._id.chapterIndex %>" data-name="<%= tp.topicName %>">
                    Ch. <%= tp._id.chapterIndex %>, Topic <%= tp._id.topicIndex %> ‚Äî <%= tp.topicName %>
                  </option>
                <% }) %>
              </select>
              <input type="text" id="noteTopicName" name="topicName" placeholder="Auto-filled topic name" readonly>

              <label>Or Create New Topic:</label>
              <div class="form-grid-2">
                <div>
                  <label style="font-size: 12px; color: #ffd700; margin: 0 0 4px 0;">Topic Index:</label>
                  <input type="number" name="newTopicIndex" id="noteNewTopicIndex" min="1" placeholder="Auto" title="Leave empty for auto-numbering" style="text-align: center; font-weight: 600; border-color: rgba(255,215,0,0.3);">
                </div>
                <div>
                  <label style="font-size: 12px; color: #ffd700; margin: 0 0 4px 0;">Topic Name:</label>
                  <input type="text" name="newTopicName" id="noteNewTopicName" placeholder="Enter new topic name">
                </div>
              </div>
              <small class="info-box gold">üí° Leave index empty for smart auto-numbering</small>

              <label>Note Title: <span style="color: #ff6b6b;">*</span></label>
              <input type="text" name="noteTitle" id="noteTitle" required placeholder="e.g., €ÅŸÜÿØ€å ÿ∑ÿ® - ÿ¢€åŸàÿ±Ÿà€åÿØ">

              <!-- UPLOAD METHOD TOGGLE -->
              <div class="upload-toggle-container gold">
                <label style="font-size: 16px; font-weight: 600; margin-bottom: 12px; display: block;">Upload Method:</label>
                <div class="upload-toggle-row">
                  <label class="upload-method-card active" id="noteFileCard" style="border-color: rgba(255,215,0,0.5); background: rgba(255,215,0,0.15);">
                    <input type="radio" name="noteUploadMethod" value="file" id="noteMethodFile" checked style="width: auto; margin: 0;">
                    <span style="font-weight: 500;">üìÅ Upload HTML File</span>
                  </label>
                  <label class="upload-method-card" id="noteTextCard">
                    <input type="radio" name="noteUploadMethod" value="text" id="noteMethodText" style="width: auto; margin: 0;">
                    <span style="font-weight: 500;">‚úçÔ∏è Paste HTML Text</span>
                  </label>
                </div>

                <!-- FILE UPLOAD SECTION -->
                <div id="noteFileUploadSection">
                  <label>Upload HTML File: <span style="color: #ff6b6b;">*</span></label>
                  <input type="file" name="htmlFile" id="noteHtmlFile" accept=".html,.htm,text/html" style="padding: 12px; background: rgba(0,0,0,0.3); border: 2px dashed rgba(255,215,0,0.5); cursor: pointer;">
                  <small style="display: block; margin-top: -10px; margin-bottom: 16px; color: #888;">
                    üìÑ Upload a .html file with your note content
                  </small>
                  <div id="noteFilePreview" style="display: none; margin-top: 12px; padding: 12px; background: rgba(0,255,136,0.1); border-left: 3px solid #00ff88; border-radius: 8px;">
                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                      <span style="font-size: 20px;">‚úÖ</span>
                      <strong id="noteFileName" style="color: #00ff88;"></strong>
                    </div>
                    <small id="noteFileInfo" style="color: #888;"></small>
                  </div>
                </div>

                <!-- TEXT PASTE SECTION -->
                <div id="noteTextUploadSection" style="display: none;">
                  <label>HTML Content: <span style="color: #ff6b6b;">*</span></label>
                  <textarea name="htmlContent" id="noteHtmlContent" placeholder="Paste your complete HTML here..." style="min-height: 300px; font-family: monospace;"></textarea>
                  <small style="display: block; margin-top: -10px; margin-bottom: 16px; color: #888;">
                    üí° Paste your entire HTML file content here. It will be displayed as-is to users.
                  </small>
                </div>
              </div>

              <label style="display: flex; align-items: center; gap: 8px; margin-top: 16px;">
                <input type="checkbox" name="isPremium" id="noteIsPremium" style="width: auto; margin: 0;">
                <span>üîí Mark as Premium Content</span>
              </label>

              <button type="submit" id="note-submit-btn">Add Note</button>
            </form>
          </div>
        </div>
      </div>

      <!-- Premium Management Section -->
      <div class="section" id="premium-section">
        <div style="max-width: 1200px; margin: 0 auto;">
          <h1 class="title">‚≠ê Premium Management</h1>

          <!-- Flashcard Chapter Premium Status -->
          <div class="container">
            <h2>Flashcard Chapter Premium Status</h2>
            <p style="color: #888; margin-bottom: 16px; font-size: 13px;">
              Toggle flashcard chapters between Free and Premium. When you mark a chapter as premium, 
              ALL topics and flashcards in that chapter become premium.
            </p>
            <div class="table-wrapper">
              <table>
                <thead>
                  <tr>
                    <th>Chapter</th>
                    <th>Name</th>
                    <th>Status</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  <% chapters.forEach(ch => { %>
                    <tr>
                      <td>Ch. <%= ch._id %></td>
                      <td><%= ch.chapterName %></td>
                      <td>
                        <% if (ch.isPremium) { %>
                          <span class="badge badge-premium">üîí Premium</span>
                        <% } else { %>
                          <span class="badge badge-free">üîì Free</span>
                        <% } %>
                      </td>
                      <td>
                        <% if (ch.isPremium) { %>
                          <button onclick="toggleChapterPremium(<%= ch._id %>, false)" style="background: rgba(0,255,136,0.15); border-color: rgba(0,255,136,0.25);">üîì Make Free</button>
                        <% } else { %>
                          <button onclick="toggleChapterPremium(<%= ch._id %>, true)" style="background: rgba(255,215,0,0.15); border-color: rgba(255,215,0,0.25);">üîí Make Premium</button>
                        <% } %>
                      </td>
                    </tr>
                  <% }) %>
                </tbody>
              </table>
            </div>
          </div>

          <!-- Notes Chapter Premium Status -->
          <div class="container">
            <h2>Notes Chapter Premium Status</h2>
            <p style="color: #888; margin-bottom: 16px; font-size: 13px;">Toggle note chapters between Free and Premium.</p>
            <div class="table-wrapper">
              <table>
                <thead>
                  <tr>
                    <th>Chapter</th>
                    <th>Name</th>
                    <th>Status</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  <% if (noteChapters.length === 0) { %>
                    <tr>
                      <td colspan="4" style="text-align: center; color: #888;">No note chapters yet</td>
                    </tr>
                  <% } else { %>
                    <% noteChapters.forEach(ch => { %>
                      <tr>
                        <td>Ch. <%= ch._id %></td>
                        <td><%= ch.chapterName %></td>
                        <td>
                          <% if (ch.isPremium) { %>
                            <span class="badge badge-premium">üîí Premium</span>
                          <% } else { %>
                            <span class="badge badge-free">üîì Free</span>
                          <% } %>
                        </td>
                        <td>
                          <% if (ch.isPremium) { %>
                            <button onclick="toggleNoteChapterPremium(<%= ch._id %>, false)" style="background: rgba(0,255,136,0.15); border-color: rgba(0,255,136,0.25);">üîì Make Free</button>
                          <% } else { %>
                            <button onclick="toggleNoteChapterPremium(<%= ch._id %>, true)" style="background: rgba(255,215,0,0.15); border-color: rgba(255,215,0,0.25);">üîí Make Premium</button>
                          <% } %>
                        </td>
                      </tr>
                    <% }) %>
                  <% } %>
                </tbody>
              </table>
            </div>
          </div>

          <!-- Topic Premium Status -->
          <div class="container">
            <h2>Flashcard Topic Premium Status</h2>
            <p style="color: #888; margin-bottom: 16px; font-size: 13px;">
              Toggle individual topics between Free and Premium.
            </p>
            
            <% 
              let premiumCurrentChapter = null;
              topics.forEach((tp, index) => {
                if (premiumCurrentChapter !== tp._id.chapterIndex) {
                  if (premiumCurrentChapter !== null) { 
            %>
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            <% } %>
            
            <div style="background: rgba(255, 255, 255, 0.02); border-radius: 12px; padding: 16px; margin-bottom: 16px; border: 1px solid rgba(255,255,255,0.04);">
              <div class="collapsible-header" onclick="toggleCollapse(this)">
                <h3 style="margin-bottom: 0;">Ch. <%= tp._id.chapterIndex %>: <%= tp.chapterName %></h3>
                <span class="collapse-icon">‚ñº</span>
              </div>
              <div class="collapsible-content">
                <div class="table-wrapper">
                  <table style="margin-top: 12px;">
                    <thead>
                      <tr>
                        <th>Topic</th>
                        <th>Name</th>
                        <th>Status</th>
                        <th>Actions</th>
                      </tr>
                    </thead>
                    <tbody>
            <%
                  premiumCurrentChapter = tp._id.chapterIndex;
                } 
            %>
                      <tr>
                        <td>Topic <%= tp._id.topicIndex %></td>
                        <td><%= tp.topicName %></td>
                        <td>
                          <% if (tp.isPremium) { %>
                            <span class="badge badge-premium">üîí Premium</span>
                          <% } else { %>
                            <span class="badge badge-free">üîì Free</span>
                          <% } %>
                        </td>
                        <td>
                          <% if (tp.isPremium) { %>
                            <button onclick="toggleTopicPremium(<%= tp._id.chapterIndex %>, <%= tp._id.topicIndex %>, false)" style="background: rgba(0,255,136,0.15); border-color: rgba(0,255,136,0.25);">üîì Free</button>
                          <% } else { %>
                            <button onclick="toggleTopicPremium(<%= tp._id.chapterIndex %>, <%= tp._id.topicIndex %>, true)" style="background: rgba(255,215,0,0.15); border-color: rgba(255,215,0,0.25);">üîí Premium</button>
                          <% } %>
                        </td>
                      </tr>
            <% 
                if (index === topics.length - 1) { 
            %>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
            <% 
                } 
              }) 
            %>
          </div>

          <!-- User Subscriptions -->
          <div class="container">
            <h2>User Subscriptions</h2>
            <p style="color: #888; margin-bottom: 16px; font-size: 13px;">
              Manage user subscription status and expiry dates. Admins automatically have full access.
            </p>
            <div class="table-wrapper">
              <table>
                <thead>
                  <tr>
                    <th>User ID</th>
                    <th>Username</th>
                    <th>Role</th>
                    <th>Subscription</th>
                    <th>Expiry</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  <% users.forEach(user => { %>
                    <tr>
                      <td><%= user.userId %></td>
                      <td><%= user.username %></td>
                      <td>
                        <% if (user.role === 'admin') { %>
                          <span class="badge badge-admin">üëë <%= user.role %></span>
                        <% } else { %>
                          <span style="text-transform: capitalize;"><%= user.role %></span>
                        <% } %>
                      </td>
                      <td>
                        <% if (user.subscriptionStatus === 'premium') { %>
                          <span class="badge badge-premium">‚≠ê Premium</span>
                        <% } else { %>
                          <span style="color: #888;">Free</span>
                        <% } %>
                      </td>
                      <td>
                        <% if (user.subscriptionExpiry) { %>
                          <%= new Date(user.subscriptionExpiry).toLocaleDateString() %>
                        <% } else if (user.subscriptionStatus === 'premium') { %>
                          <span style="color: #00ff88;">Lifetime</span>
                        <% } else { %>
                          -
                        <% } %>
                      </td>
                      <td>
                        <button onclick="openSubscriptionModal('<%= user.userId %>', '<%= user.username.replace(/'/g, "\\'") %>', '<%= user.subscriptionStatus %>', '<%= user.subscriptionExpiry || "" %>')">‚úèÔ∏è Manage</button>
                      </td>
                    </tr>
                  <% }) %>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- Users Section -->
      <div class="section" id="users-section">
        <div style="max-width: 1200px; margin: 0 auto;">
          <h1 class="title">üë• User Management</h1>
          
          <div class="container">
            <h2>Current Users</h2>
            <div class="table-wrapper">
              <table>
                <thead>
                  <tr>
                    <th>User ID</th>
                    <th>Username</th>
                    <th>Role</th>
                    <th>Subscription</th>
                    <th>Device Lock</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  <% users.forEach(user => { %>
                    <tr>
                      <td><%= user.userId %></td>
                      <td><%= user.username %></td>
                      <td><span style="text-transform: capitalize;"><%= user.role %></span></td>
                      <td>
                        <% if (user.subscriptionStatus === 'premium') { %>
                          <span class="badge badge-premium">‚≠ê Premium</span>
                        <% } else { %>
                          <span style="color: #888;">Free</span>
                        <% } %>
                      </td>
                      <td>
                        <% if (user.deviceLock && user.deviceLock.deviceFingerprint && user.deviceLock.expiresAt > new Date()) { %>
                          <span class="badge badge-locked">üîí Locked</span>
                          <br><small style="color: #888;">Exp: <%= new Date(user.deviceLock.expiresAt).toLocaleDateString() %></small>
                        <% } else { %>
                          <span class="badge badge-free">üîì None</span>
                        <% } %>
                      </td>
                      <td>
                        <button onclick="forceLogout('<%= user.userId %>', '<%= user.username.replace(/'/g, "\\'") %>')">üö™ Logout</button>
                        <% if (user.deviceLock && user.deviceLock.deviceFingerprint && user.deviceLock.expiresAt > new Date()) { %>
                          <button onclick="clearDeviceLock('<%= user.userId %>', '<%= user.username.replace(/'/g, "\\'") %>')" style="background: rgba(255,165,0,0.15); border-color: rgba(255,165,0,0.25);">üîì Unlock</button>
                        <% } %>
                        <button onclick="openDeleteUserModal('<%= user.userId %>', '<%= user.username.replace(/'/g, "\\'") %>')" class="danger">üóëÔ∏è Del</button>
                      </td>
                    </tr>
                  <% }) %>
                </tbody>
              </table>
            </div>
          </div>

          <div class="container">
            <h2>‚ûï Add New User</h2>
            <form action="/admin/add-user" method="POST">
              <label>User ID: <span style="color: #ff6b6b;">*</span></label>
              <input type="text" name="userId" required placeholder="Enter unique user ID">

              <label>Username: <span style="color: #ff6b6b;">*</span></label>
              <input type="text" name="username" required placeholder="Enter username">

              <label>Password: <span style="color: #ff6b6b;">*</span></label>
              <input type="password" name="password" required placeholder="Enter password">

              <label>Role: <span style="color: #ff6b6b;">*</span></label>
              <select name="role" required>
                <option value="user">User</option>
                <option value="admin">Admin</option>
              </select>

              <label>Subscription Status:</label>
              <select name="subscriptionStatus">
                <option value="free">Free</option>
                <option value="premium">Premium</option>
              </select>

              <button type="submit">Add User</button>
            </form>
          </div>
        </div>
      </div>

      <!-- Device Locks Section -->
      <div class="section" id="device-locks-section">
        <div style="max-width: 1200px; margin: 0 auto;">
          <h1 class="title">üîí Device Lock Management</h1>
          
          <div class="container">
            <div class="info-panel">
              <h3>‚ÑπÔ∏è How Device Locks Work</h3>
              <ul>
                <li><strong>Premium users</strong> are locked to one device for 30 days after login</li>
                <li><strong>Free users</strong> have NO device lock ‚Äî they can login from anywhere</li>
                <li><strong>Admins</strong> are exempt from all device locks</li>
                <li>Device lock <strong>persists after logout</strong> ‚Äî logging out doesn't clear the lock</li>
                <li>Only <strong>you (admin)</strong> can manually clear a device lock, or it expires after 30 days</li>
              </ul>
            </div>

            <div class="filter-bar">
              <button onclick="loadDeviceLocks()">üîÑ Refresh Locks</button>
              <button onclick="loadActiveSessions()">üìä View Active Sessions</button>
            </div>

            <h2>Active Device Locks</h2>
            <div id="device-locks-list">
              <p style="color: #888; text-align: center; padding: 40px;">
                Click "Refresh Locks" to load active device locks
              </p>
            </div>
          </div>

          <div class="container">
            <h2>Active Sessions</h2>
            <div id="active-sessions-list">
              <p style="color: #888; text-align: center; padding: 40px;">
                Click "View Active Sessions" to load
              </p>
            </div>
          </div>

          <div class="container">
            <h2>üîì Quick Clear Device Lock</h2>
            <p style="color: #888; margin-bottom: 16px; font-size: 13px;">
              Enter a username to quickly clear their device lock. Use this when a user contacts you saying they bought a new phone.
            </p>
            <div class="quick-clear-row">
              <div>
                <label style="margin-top: 0;">Username:</label>
                <input type="text" id="quickClearUsername" placeholder="Enter username" style="margin-bottom: 0;">
              </div>
              <button onclick="quickClearDeviceLock()" style="background: rgba(255,165,0,0.15); border-color: rgba(255,165,0,0.25); white-space: nowrap;">
                üîì Clear Lock
              </button>
            </div>
          </div>
        </div>
      </div>

    </main>
  </div>

  <!-- Mobile Menu Button -->
  <button class="mobile-menu-btn" id="mobileMenuBtn" onclick="toggleMobileMenu()" aria-label="Toggle menu">‚ò∞</button>

  <!-- Toast Container -->
  <div id="toast-container"></div>

  <!-- ========== MODALS ========== -->
  
  <!-- Edit Chapter Modal -->
  <div class="modal" id="edit-chapter-modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal('edit-chapter-modal')">&times;</span>
      <h3>Edit Chapter Name</h3>
      <form action="/admin/edit-chapter" method="POST">
        <input type="hidden" name="oldChapterIndex" id="edit-old-chapter-index">
        <label>New Chapter Name:</label>
        <input type="text" name="newChapterName" id="edit-new-chapter-name" placeholder="New chapter name" required>
        <button type="submit">Update Chapter</button>
      </form>
    </div>
  </div>

  <!-- Delete Chapter Modal -->
  <div class="modal" id="delete-chapter-modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal('delete-chapter-modal')">&times;</span>
      <h3>‚ö†Ô∏è Delete Chapter</h3>
      <p style="color: #ff9999; margin-bottom: 20px;">
        Are you sure you want to delete Chapter <span id="delete-chapter-number"></span>? 
        This will delete ALL topics and flashcards in this chapter!
      </p>
      <form action="/admin/delete-chapter" method="POST">
        <input type="hidden" name="chapterIndex" id="delete-chapter-index">
        <div style="display: flex; gap: 8px; flex-wrap: wrap;">
          <button type="submit" class="danger">Yes, Delete Chapter</button>
          <button type="button" onclick="closeModal('delete-chapter-modal')">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Edit Topic Modal -->
  <div class="modal" id="edit-topic-modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal('edit-topic-modal')">&times;</span>
      <h3>Edit Topic Name</h3>
      <form action="/admin/edit-topic" method="POST">
        <input type="hidden" id="edit-topic-chapter" name="chapterIndex">
        <input type="hidden" id="edit-topic-index" name="topicIndex">
        <label>New Topic Name:</label>
        <input type="text" id="edit-topic-name" name="newTopicName" placeholder="New topic name" required>
        <button type="submit">Update Topic</button>
      </form>
    </div>
  </div>

  <!-- Delete Topic Modal -->
  <div class="modal" id="delete-topic-modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal('delete-topic-modal')">&times;</span>
      <h3>‚ö†Ô∏è Delete Topic</h3>
      <p style="color: #ff9999; margin-bottom: 20px;">
        Are you sure you want to delete topic "<span id="delete-topic-name"></span>"? 
        This will delete ALL flashcards in this topic!
      </p>
      <form action="/admin/delete-topic" method="POST">
        <input type="hidden" name="chapterIndex" id="delete-topic-chapter">
        <input type="hidden" name="topicIndex" id="delete-topic-index">
        <div style="display: flex; gap: 8px; flex-wrap: wrap;">
          <button type="submit" class="danger">Yes, Delete Topic</button>
          <button type="button" onclick="closeModal('delete-topic-modal')">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <!-- View Flashcards Modal -->
  <div class="modal" id="view-flashcards-modal">
    <div class="modal-content" style="max-width: 800px;">
      <span class="close" onclick="closeModal('view-flashcards-modal')">&times;</span>
      <h3 id="flashcards-modal-title">Flashcards</h3>
      <div id="flashcards-list" style="max-height: 60vh; overflow-y: auto;"></div>
    </div>
  </div>

  <!-- Edit Flashcard Modal -->
  <div class="modal" id="edit-flashcard-modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal('edit-flashcard-modal')">&times;</span>
      <h3>Edit Flashcard</h3>
      <form id="edit-flashcard-form">
        <input type="hidden" id="edit-flashcard-id">
        <label>Question:</label>
        <textarea id="edit-flashcard-question" required></textarea>
        <label>Answer:</label>
        <textarea id="edit-flashcard-answer" required></textarea>
        <button type="submit">Update Flashcard</button>
      </form>
    </div>
  </div>

  <!-- Delete Flashcard Modal -->
  <div class="modal" id="delete-flashcard-modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal('delete-flashcard-modal')">&times;</span>
      <h3>‚ö†Ô∏è Delete Flashcard</h3>
      <p style="color: #ff9999; margin-bottom: 16px;">Are you sure you want to delete this flashcard?</p>
      <p id="delete-flashcard-preview" style="color: #888; margin-bottom: 20px; font-style: italic;"></p>
      <input type="hidden" id="delete-flashcard-id">
      <div style="display: flex; gap: 8px; flex-wrap: wrap;">
        <button onclick="confirmDeleteFlashcard()" class="danger">Yes, Delete</button>
        <button onclick="closeModal('delete-flashcard-modal')">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Edit Note Modal -->
  <div class="modal" id="edit-note-modal">
    <div class="modal-content" style="max-width: 900px;">
      <span class="close" onclick="closeModal('edit-note-modal')">&times;</span>
      <h3>Edit Note</h3>
      <form id="edit-note-form">
        <input type="hidden" id="edit-note-id">
        
        <label>Note Title:</label>
        <input type="text" id="edit-note-title" required placeholder="Note title">
        
        <label>HTML Content:</label>
        <textarea id="edit-note-content" required style="min-height: 300px; font-family: monospace;" placeholder="Paste HTML content here"></textarea>
        
        <label style="display: flex; align-items: center; gap: 8px; margin-top: 16px;">
          <input type="checkbox" id="edit-note-premium" style="width: auto; margin: 0;">
          <span>üîí Mark as Premium Content</span>
        </label>
        
        <button type="submit">Update Note</button>
      </form>
    </div>
  </div>

  <!-- Delete Note Modal -->
  <div class="modal" id="delete-note-modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal('delete-note-modal')">&times;</span>
      <h3>‚ö†Ô∏è Delete Note</h3>
      <p style="color: #ff9999; margin-bottom: 16px;">Are you sure you want to delete this note?</p>
      <p id="delete-note-preview" style="color: #888; margin-bottom: 20px; font-style: italic;"></p>
      <input type="hidden" id="delete-note-id">
      <div style="display: flex; gap: 8px; flex-wrap: wrap;">
        <button onclick="confirmDeleteNote()" class="danger">Yes, Delete</button>
        <button onclick="closeModal('delete-note-modal')">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Delete User Modal -->
  <div class="modal" id="delete-user-modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal('delete-user-modal')">&times;</span>
      <h3>‚ö†Ô∏è Delete User</h3>
      <p style="color: #ff9999; margin-bottom: 20px;">
        Are you sure you want to delete user "<span id="delete-user-name"></span>"?
      </p>
      <form action="/admin/delete-user" method="POST">
        <input type="hidden" name="userId" id="delete-user-id">
        <div style="display: flex; gap: 8px; flex-wrap: wrap;">
          <button type="submit" class="danger">Yes, Delete User</button>
          <button type="button" onclick="closeModal('delete-user-modal')">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Subscription Management Modal -->
  <div class="modal" id="subscription-modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal('subscription-modal')">&times;</span>
      <h3>‚≠ê Manage User Subscription</h3>
      <p style="color: #888; margin-bottom: 20px;">
        User: <strong id="sub-username" style="color: #fff;"></strong>
      </p>
      
      <form action="/admin/update-subscription" method="POST">
        <input type="hidden" name="userId" id="sub-userId">
        
        <label>Subscription Status: <span style="color: #ff6b6b;">*</span></label>
        <select name="subscriptionStatus" id="sub-status" required>
          <option value="free">Free</option>
          <option value="premium">Premium</option>
        </select>
        
        <label>Expiry Date (Optional):</label>
        <input type="date" name="subscriptionExpiry" id="sub-expiry" placeholder="YYYY-MM-DD">
        <small class="info-box">
          Leave empty for lifetime premium access. Only applies if status is Premium.
          <br>‚ö†Ô∏è Downgrading to Free will also clear the user's device lock.
        </small>
        
        <div style="display: flex; gap: 8px; flex-wrap: wrap; margin-top: 16px;">
          <button type="submit" style="background: rgba(255,215,0,0.15); border-color: rgba(255,215,0,0.25);">‚≠ê Update Subscription</button>
          <button type="button" onclick="closeModal('subscription-modal')" style="background: rgba(255,255,255,0.08);">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <!-- JavaScript -->
  <script>
  window.chapters = <%- JSON.stringify(chapters) %>;
  window.topics = <%- JSON.stringify(topics) %>;
  window.noteChapters = <%- JSON.stringify(noteChapters) %>;
  window.noteTopics = <%- JSON.stringify(noteTopics) %>;

  function findNextAvailableIndex(existingIndices) {
    if (existingIndices.length === 0) return 1;
    const sorted = [...existingIndices].sort((a, b) => a - b);
    for (let i = 0; i < sorted.length; i++) {
      if (sorted[i] !== i + 1) return i + 1;
    }
    return sorted[sorted.length - 1] + 1;
  }

  // Enhanced mobile menu with overlay
  function toggleMobileMenu() {
    const sidebar = document.getElementById('sidebar');
    const overlay = document.getElementById('sidebarOverlay');
    const btn = document.getElementById('mobileMenuBtn');
    const isOpen = sidebar.classList.toggle('mobile-open');
    overlay.classList.toggle('active', isOpen);
    btn.textContent = isOpen ? '‚úï' : '‚ò∞';
    document.body.style.overflow = isOpen ? 'hidden' : '';
  }

  function closeMobileMenu() {
    const sidebar = document.getElementById('sidebar');
    const overlay = document.getElementById('sidebarOverlay');
    const btn = document.getElementById('mobileMenuBtn');
    sidebar.classList.remove('mobile-open');
    overlay.classList.remove('active');
    btn.textContent = '‚ò∞';
    document.body.style.overflow = '';
  }

  // Close mobile menu when nav item clicked
  const originalShowSection = window.showSection;
  const navItems = document.querySelectorAll('.nav-item');
  navItems.forEach(item => {
    const originalOnclick = item.getAttribute('onclick');
    if (originalOnclick) {
      item.addEventListener('click', () => {
        if (window.innerWidth <= 768) {
          closeMobileMenu();
        }
      });
    }
  });

  // Close sidebar on escape key
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      closeMobileMenu();
      // Also close any open modals
      document.querySelectorAll('.modal').forEach(m => {
        if (m.style.display === 'flex') {
          m.style.display = 'none';
        }
      });
    }
  });

  // Handle window resize
  let resizeTimer;
  window.addEventListener('resize', () => {
    clearTimeout(resizeTimer);
    resizeTimer = setTimeout(() => {
      if (window.innerWidth > 768) {
        closeMobileMenu();
      }
    }, 100);
  });
  </script>

  <script src="/clientadmin.js"></script>

</body>
</html>

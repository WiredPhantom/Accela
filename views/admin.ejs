<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Panel</title>
  <link rel="stylesheet" href="/admin.css">
</head>
  
<body>
  <div class="admin-layout">
    <!-- Sidebar Navigation -->
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <h2>üìö Admin Panel</h2>
      </div>
      <nav>
        <a class="nav-item active" onclick="showSection('dashboard')" data-section="dashboard">
          <span class="icon">üìä</span>
          Dashboard
        </a>
        <a class="nav-item" onclick="showSection('chapters')" data-section="chapters">
          <span class="icon">üìö</span>
          Chapters
        </a>
        <a class="nav-item" onclick="showSection('topics')" data-section="topics">
          <span class="icon">üìù</span>
          Topics
        </a>
        <a class="nav-item" onclick="showSection('flashcards')" data-section="flashcards">
          <span class="icon">üé¥</span>
          All Flashcards
        </a>
        <a class="nav-item" onclick="showSection('add-content')" data-section="add-content">
          <span class="icon">‚ûï</span>
          Add Content
        </a>
        <a class="nav-item" onclick="showSection('bulk-upload')" data-section="bulk-upload">
          <span class="icon">üì¶</span>
          Bulk Upload
        </a>
        <a class="nav-item" onclick="showSection('premium')" data-section="premium">
          <span class="icon">‚≠ê</span>
          Premium Management
        </a>
        <a class="nav-item" onclick="showSection('users')" data-section="users">
          <span class="icon">üë•</span>
          Users
        </a>
      </nav>
      <div class="sidebar-footer">
        <a href="/" class="home-btn" style="width: 100%; text-align: center; display: block; margin-bottom: 12px;">‚Üê Back to Home</a>
        <form action="/logout" method="GET">
          <button type="submit" class="danger" style="width: 100%;">Logout</button>
        </form>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
      <!-- Search Bar -->
      <div class="search-section">
        <div class="search-bar">
          <input type="text" class="search-input" id="globalSearch" placeholder="üîç Search chapters, topics, or flashcards..." oninput="performSearch()">
          <button onclick="clearSearch()">Clear</button>
        </div>
      </div>

      <!-- Dashboard Section -->
      <div class="section active" id="dashboard-section">
        <div style="max-width: 1200px; margin: 0 auto;">
          <h1 class="title">Dashboard</h1>
          
          <div class="stats-grid">
            <div class="stat-card">
              <div class="icon">üìö</div>
              <div class="number" id="stat-chapters"><%= chapters.length %></div>
              <div class="label">Total Chapters</div>
            </div>
            <div class="stat-card">
              <div class="icon">üìù</div>
              <div class="number" id="stat-topics"><%= topics.length %></div>
              <div class="label">Total Topics</div>
            </div>
            <div class="stat-card">
              <div class="icon">üé¥</div>
              <div class="number" id="stat-flashcards"><span class="loading"></span></div>
              <div class="label">Total Flashcards</div>
            </div>
            <div class="stat-card">
              <div class="icon">üë•</div>
              <div class="number" id="stat-users"><%= users.length %></div>
              <div class="label">Total Users</div>
            </div>
          </div>

          <div class="container">
            <h2>Quick Actions</h2>
            <div class="quick-actions">
              <button onclick="showSection('add-content')">‚ûï Add Flashcard</button>
              <button onclick="showSection('bulk-upload')">üì¶ Bulk Upload</button>
              <button onclick="showSection('premium')">‚≠ê Manage Premium</button>
              <button onclick="exportAllData()">üì§ Export All Data</button>
              <button onclick="showSection('users')">üë• Manage Users</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Chapters Section -->
      <div class="section" id="chapters-section">
        <div style="max-width: 1200px; margin: 0 auto;">
          <h1 class="title">Chapters Management</h1>
          <div class="container">
            <table>
              <thead>
                <tr>
                  <th>Index</th>
                  <th>Name</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <% chapters.forEach(ch => { %>
                  <tr>
                    <td>Chapter <%= ch._id %></td>
                    <td><%= ch.chapterName %></td>
                    <td>
                      <button onclick="openEditChapterModal(<%= ch._id %>, '<%= ch.chapterName.replace(/'/g, "\\'") %>')">‚úèÔ∏è Edit</button>
                      <button onclick="openDeleteChapterModal(<%= ch._id %>)" class="danger">üóëÔ∏è Delete</button>
                    </td>
                  </tr>
                <% }) %>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Topics Section -->
      <div class="section" id="topics-section">
        <div style="max-width: 1200px; margin: 0 auto;">
          <h1 class="title">Topics by Chapter</h1>
          <% 
            let currentChapter = null;
            topics.forEach((tp, index) => {
              if (currentChapter !== tp._id.chapterIndex) {
                if (currentChapter !== null) { 
          %>
                  </ul>
                </div>
              </div>
            <% } %>
            
            <div class="container">
              <div class="collapsible-header" onclick="toggleCollapse(this)">
                <h2>Chapter <%= tp._id.chapterIndex %>: <%= tp.chapterName %></h2>
                <span class="collapse-icon">‚ñº</span>
              </div>
              <div class="collapsible-content">
                <ul class="topic-list">
          <%
                currentChapter = tp._id.chapterIndex;
              } 
          %>
                  <li class="topic-item">
                    <div>
                      <strong>Topic <%= tp._id.topicIndex %>: <%= tp.topicName %></strong>
                      <span class="card-count" id="count-<%= tp._id.chapterIndex %>-<%= tp._id.topicIndex %>">...</span>
                    </div>
                    <div>
                      <button onclick="viewFlashcards(<%= tp._id.chapterIndex %>, <%= tp._id.topicIndex %>, '<%= tp.topicName.replace(/'/g, "\\'") %>')">üìã View Cards</button>
                      <button onclick="openTopicEditModal('<%= tp._id.chapterIndex %>', '<%= tp._id.topicIndex %>', '<%= tp.topicName.replace(/'/g, "\\'") %>')">‚úèÔ∏è Edit</button>
                      <button onclick="openDeleteTopicModal('<%= tp._id.chapterIndex %>', '<%= tp._id.topicIndex %>', '<%= tp.topicName.replace(/'/g, "\\'") %>')" class="danger">üóëÔ∏è Delete</button>
                    </div>
                  </li>
          <% 
              if (index === topics.length - 1) { 
          %>
                </ul>
              </div>
            </div>
          <% 
              } 
            }) 
          %>
        </div>
      </div>

      <!-- All Flashcards Section -->
      <div class="section" id="flashcards-section">
        <div style="max-width: 1200px; margin: 0 auto;">
          <h1 class="title">All Flashcards</h1>
          <div class="container">
            <div style="margin-bottom: 20px; display: flex; gap: 12px; flex-wrap: wrap;">
              <select id="filterChapter" onchange="filterFlashcards()">
                <option value="">All Chapters</option>
                <% chapters.forEach(ch => { %>
                  <option value="<%= ch._id %>">Chapter <%= ch._id %>: <%= ch.chapterName %></option>
                <% }) %>
              </select>
              <select id="filterTopic" onchange="filterFlashcards()" disabled>
                <option value="">All Topics</option>
              </select>
              <button onclick="loadAllFlashcards()">üîÑ Refresh</button>
            </div>
            <div id="all-flashcards-list">
              <p style="color: #888; text-align: center; padding: 40px;">
                <span class="loading"></span> Loading flashcards...
              </p>
            </div>
          </div>
        </div>
      </div>

      <!-- Add Content Section -->
      <div class="section" id="add-content-section">
        <div style="max-width: 1200px; margin: 0 auto;">
          <h1 class="title">‚ûï Add Flashcard</h1>
          <div class="container">
            <form action="/admin/add-flashcard" method="POST" id="add-flashcard-form">
              <label>Select Chapter:</label>
              <select id="chapterIndex" name="chapterIndex" onchange="fillChapterName()">
                <option value="">-- Select Chapter --</option>
                <% chapters.forEach(ch => { %>
                  <option value="<%= ch._id %>"><%= ch._id %> ‚Äî <%= ch.chapterName %></option>
                <% }) %>
              </select>
              <input type="text" id="chapterName" name="chapterName" placeholder="Auto-filled chapter name" readonly>

              <label>Or Create New Chapter:</label>
              <input type="text" name="newChapterName" id="newChapterName" placeholder="Enter new chapter name">
              <input type="hidden" name="newChapterIndex" id="newChapterIndex">

              <label>Select Topic:</label>
              <select id="topicIndex" name="topicIndex" onchange="fillTopicName()">
                <option value="">-- Select Topic --</option>
                <% topics.forEach(tp => { %>
                  <option value="<%= tp._id.topicIndex %>" data-chapter="<%= tp._id.chapterIndex %>" data-name="<%= tp.topicName %>">
                    Chapter <%= tp._id.chapterIndex %>, Topic <%= tp._id.topicIndex %> ‚Äî <%= tp.topicName %>
                  </option>
                <% }) %>
              </select>
              <input type="text" id="topicName" name="topicName" placeholder="Auto-filled topic name" readonly>

              <label>Or Create New Topic:</label>
              <input type="text" name="newTopicName" id="newTopicName" placeholder="Enter new topic name">
              <input type="hidden" name="newTopicIndex" id="newTopicIndex">

              <label>Question: <span style="color: #ff6b6b;">*</span></label>
              <textarea name="question" required placeholder="Enter the question here"></textarea>
              
              <label>Answer: <span style="color: #ff6b6b;">*</span></label>
              <textarea name="answer" required placeholder="Enter the answer here"></textarea>

              <label style="display: flex; align-items: center; gap: 8px; margin-top: 16px;">
                <input type="checkbox" name="isPremium" id="isPremium" style="width: auto; margin: 0;">
                <span>üîí Mark as Premium Content</span>
              </label>
              <small style="display: block; margin-top: -8px; margin-bottom: 16px; margin-left: 28px; color: #888;">
                Check this box to make this flashcard premium-only
              </small>

              <button type="submit" id="submit-flashcard-btn">Add Flashcard</button>
            </form>
          </div>
        </div>
      </div>

      <!-- Bulk Upload Section -->
      <div class="section" id="bulk-upload-section">
        <div style="max-width: 1200px; margin: 0 auto;">
          <h1 class="title">üì¶ Bulk Upload Flashcards</h1>
          <div class="container">
            <form action="/admin/bulk-upload" method="POST" id="bulk-upload-form">
              <label>Select Chapter:</label>
              <select id="bulkChapterIndex" name="chapterIndex" onchange="fillBulkChapterName()">
                <option value="">-- Select Chapter --</option>
                <% chapters.forEach(ch => { %>
                  <option value="<%= ch._id %>"><%= ch._id %> ‚Äî <%= ch.chapterName %></option>
                <% }) %>
              </select>
              <input type="text" name="chapterName" id="bulkChapterName" readonly placeholder="Auto-filled chapter name">

              <label>Or Create New Chapter:</label>
              <input type="text" name="newChapterName" id="bulknewChapterName" placeholder="Enter new chapter name">
              <input type="hidden" name="newChapterIndex" id="bulknewChapterIndex">

              <label>Select Topic:</label>
              <select id="bulkTopicIndex" name="topicIndex" onchange="fillBulkTopicName()">
                <option value="">-- Select Topic --</option>
                <% topics.forEach(tp => { %>
                  <option value="<%= tp._id.topicIndex %>" data-chapter="<%= tp._id.chapterIndex %>" data-name="<%= tp.topicName %>">
                    Chapter <%= tp._id.chapterIndex %>, Topic <%= tp._id.topicIndex %> ‚Äî <%= tp.topicName %>
                  </option>
                <% }) %>
              </select>
              <input type="text" name="topicName" id="bulkTopicName" readonly placeholder="Auto-filled topic name">

              <label>Or Create New Topic:</label>
              <input type="text" name="newTopicName" id="bulknewTopicName" placeholder="Enter new topic name">
              <input type="hidden" name="newTopicIndex" id="bulknewTopicIndex">

              <label>Paste JSON Data: <span style="color: #ff6b6b;">*</span></label>
              <textarea name="jsonData" required placeholder='[{"question": "Q1", "answer": "A1"}, {"question": "Q2", "answer": "A2"}]' style="min-height: 250px;"></textarea>
              <small style="display: block; margin-top: -10px; margin-bottom: 16px;">
                Format: Array of objects with "question" and "answer" keys. Example shown above.
              </small>

              <label style="display: flex; align-items: center; gap: 8px; margin-top: 16px;">
                <input type="checkbox" name="isPremium" id="bulkIsPremium" style="width: auto; margin: 0;">
                <span>üîí Mark ALL uploaded flashcards as Premium</span>
              </label>
              <small style="display: block; margin-top: -8px; margin-bottom: 16px; margin-left: 28px; color: #888;">
                Check this to make all flashcards in the upload premium-only
              </small>

              <button type="submit">Upload Flashcards</button>
            </form>
          </div>
        </div>
      </div>

      <!-- Premium Management Section -->
      <div class="section" id="premium-section">
        <div style="max-width: 1200px; margin: 0 auto;">
          <h1 class="title">‚≠ê Premium Management</h1>
          
          <!-- Manage Chapter Premium Status -->
          <div class="container">
            <h2>Chapter Premium Status</h2>
            <p style="color: #888; margin-bottom: 20px;">
              Toggle chapters between Free and Premium. When you mark a chapter as premium, 
              ALL topics and flashcards in that chapter become premium.
            </p>
            <table>
              <thead>
                <tr>
                  <th>Chapter</th>
                  <th>Name</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <% chapters.forEach(ch => { %>
                  <tr>
                    <td>Chapter <%= ch._id %></td>
                    <td><%= ch.chapterName %></td>
                    <td>
                      <% if (ch.isPremium) { %>
                        <span style="color: #ffd700; font-weight: 600;">üîí Premium</span>
                      <% } else { %>
                        <span style="color: #00ff88; font-weight: 600;">üîì Free</span>
                      <% } %>
                    </td>
                    <td>
                      <% if (ch.isPremium) { %>
                        <button 
                          onclick="toggleChapterPremium(<%= ch._id %>, false)" 
                          style="background: rgba(0,255,136,0.2); border-color: rgba(0,255,136,0.3);">
                          üîì Make Free
                        </button>
                      <% } else { %>
                        <button 
                          onclick="toggleChapterPremium(<%= ch._id %>, true)" 
                          style="background: rgba(255,215,0,0.2); border-color: rgba(255,215,0,0.3);">
                          üîí Make Premium
                        </button>
                      <% } %>
                    </td>
                  </tr>
                <% }) %>
              </tbody>
            </table>
          </div>

          <!-- Manage Topic Premium Status -->
          <div class="container">
            <h2>Topic Premium Status (By Chapter)</h2>
            <p style="color: #888; margin-bottom: 20px;">
              Toggle individual topics between Free and Premium. 
              This affects all flashcards within the topic.
            </p>
            
            <% 
              let premiumCurrentChapter = null;
              topics.forEach((tp, index) => {
                if (premiumCurrentChapter !== tp._id.chapterIndex) {
                  if (premiumCurrentChapter !== null) { 
            %>
                    </tbody>
                  </table>
                </div>
              </div>
            <% } %>
            
            <div style="background: rgba(255, 255, 255, 0.03); border-radius: 12px; padding: 20px; margin-bottom: 20px;">
              <div class="collapsible-header" onclick="toggleCollapse(this)">
                <h3>Chapter <%= tp._id.chapterIndex %>: <%= tp.chapterName %></h3>
                <span class="collapse-icon">‚ñº</span>
              </div>
              <div class="collapsible-content">
                <table style="margin-top: 16px;">
                  <thead>
                    <tr>
                      <th>Topic</th>
                      <th>Name</th>
                      <th>Status</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody>
            <%
                  premiumCurrentChapter = tp._id.chapterIndex;
                } 
            %>
                    <tr>
                      <td>Topic <%= tp._id.topicIndex %></td>
                      <td><%= tp.topicName %></td>
                      <td>
                        <% if (tp.isPremium) { %>
                          <span style="color: #ffd700; font-weight: 600;">üîí Premium</span>
                        <% } else { %>
                          <span style="color: #00ff88; font-weight: 600;">üîì Free</span>
                        <% } %>
                      </td>
                      <td>
                        <% if (tp.isPremium) { %>
                          <button 
                            onclick="toggleTopicPremium(<%= tp._id.chapterIndex %>, <%= tp._id.topicIndex %>, false)" 
                            style="background: rgba(0,255,136,0.2); border-color: rgba(0,255,136,0.3);">
                            üîì Make Free
                          </button>
                        <% } else { %>
                          <button 
                            onclick="toggleTopicPremium(<%= tp._id.chapterIndex %>, <%= tp._id.topicIndex %>, true)" 
                            style="background: rgba(255,215,0,0.2); border-color: rgba(255,215,0,0.3);">
                            üîí Make Premium
                          </button>
                        <% } %>
                      </td>
                    </tr>
            <% 
                if (index === topics.length - 1) { 
            %>
                  </tbody>
                </table>
              </div>
                 <% 
                } 
              }) 
            %>
          </div>

          <!-- Manage User Subscriptions -->
          <div class="container">
            <h2>User Subscriptions</h2>
            <p style="color: #888; margin-bottom: 20px;">
              Manage user subscription status and expiry dates. Admins automatically have full access.
            </p>
            <table>
              <thead>
                <tr>
                  <th>User ID</th>
                  <th>Username</th>
                  <th>Role</th>
                  <th>Subscription</th>
                  <th>Expiry</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <% users.forEach(user => { %>
                  <tr>
                    <td><%= user.userId %></td>
                    <td><%= user.username %></td>
                    <td style="text-transform: capitalize;">
                      <% if (user.role === 'admin') { %>
                        <span style="color: #ff6b9d;">üëë <%= user.role %></span>
                      <% } else { %>
                        <%= user.role %>
                      <% } %>
                    </td>
                    <td>
                      <% if (user.subscriptionStatus === 'premium') { %>
                        <span style="color: #ffd700; font-weight: 600;">‚≠ê Premium</span>
                      <% } else { %>
                        <span style="color: #888;">Free</span>
                      <% } %>
                    </td>
                    <td>
                      <% if (user.subscriptionExpiry) { %>
                        <%= new Date(user.subscriptionExpiry).toLocaleDateString() %>
                      <% } else if (user.subscriptionStatus === 'premium') { %>
                        <span style="color: #00ff88;">Lifetime</span>
                      <% } else { %>
                        -
                      <% } %>
                    </td>
                    <td>
                      <button onclick="openSubscriptionModal('<%= user.userId %>', '<%= user.username.replace(/'/g, "\\'") %>', '<%= user.subscriptionStatus %>', '<%= user.subscriptionExpiry || "" %>')">
                        ‚úèÔ∏è Manage
                      </button>
                    </td>
                  </tr>
                <% }) %>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Users Section -->
      <div class="section" id="users-section">
        <div style="max-width: 1200px; margin: 0 auto;">
          <h1 class="title">üë• User Management</h1>
          
          <div class="container">
            <h2>Current Users</h2>
            <table>
              <thead>
                <tr>
                  <th>User ID</th>
                  <th>Username</th>
                  <th>Role</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <% users.forEach(user => { %>
                  <tr>
                    <td><%= user.userId %></td>
                    <td><%= user.username %></td>
                    <td><span style="text-transform: capitalize;"><%= user.role %></span></td>
                    <td>
                      <button onclick="openDeleteUserModal('<%= user.userId %>', '<%= user.username.replace(/'/g, "\\'") %>')" class="danger">üóëÔ∏è Delete</button>
                    </td>
                  </tr>
                <% }) %>
              </tbody>
            </table>
          </div>

          <div class="container">
            <h2>‚ûï Add New User</h2>
            <form action="/admin/add-user" method="POST">
              <label>User ID: <span style="color: #ff6b6b;">*</span></label>
              <input type="text" name="userId" required placeholder="Enter unique user ID">

              <label>Username: <span style="color: #ff6b6b;">*</span></label>
              <input type="text" name="username" required placeholder="Enter username">

              <label>Password: <span style="color: #ff6b6b;">*</span></label>
              <input type="password" name="password" required placeholder="Enter password">

              <label>Role: <span style="color: #ff6b6b;">*</span></label>
              <select name="role" required>
                <option value="user">User</option>
                <option value="admin">Admin</option>
              </select>

              <label>Subscription Status:</label>
              <select name="subscriptionStatus">
                <option value="free">Free</option>
                <option value="premium">Premium</option>
              </select>

              <button type="submit">Add User</button>
            </form>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Mobile Menu Button -->
  <button class="mobile-menu-btn" onclick="toggleMobileMenu()">‚ò∞</button>

  <!-- Toast Container -->
  <div id="toast-container"></div>

  <!-- Modals -->
  <!-- Edit Chapter Modal -->
  <div class="modal" id="edit-chapter-modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal('edit-chapter-modal')">&times;</span>
      <h3>Edit Chapter Name</h3>
      <form action="/admin/edit-chapter" method="POST">
        <input type="hidden" name="oldChapterIndex" id="edit-old-chapter-index">
        <label>New Chapter Name:</label>
        <input type="text" name="newChapterName" id="edit-new-chapter-name" placeholder="New chapter name" required>
        <button type="submit">Update Chapter</button>
      </form>
    </div>
  </div>

  <!-- Delete Chapter Modal -->
  <div class="modal" id="delete-chapter-modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal('delete-chapter-modal')">&times;</span>
      <h3>‚ö†Ô∏è Delete Chapter</h3>
      <p style="color: #ff9999; margin-bottom: 20px;">
        Are you sure you want to delete Chapter <span id="delete-chapter-number"></span>? 
        This will delete ALL topics and flashcards in this chapter!
      </p>
      <form action="/admin/delete-chapter" method="POST">
        <input type="hidden" name="chapterIndex" id="delete-chapter-index">
        <button type="submit" class="danger">Yes, Delete Chapter</button>
        <button type="button" onclick="closeModal('delete-chapter-modal')" style="margin-left: 8px;">Cancel</button>
      </form>
    </div>
  </div>

  <!-- Edit Topic Modal -->
  <div class="modal" id="edit-topic-modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal('edit-topic-modal')">&times;</span>
      <h3>Edit Topic Name</h3>
      <form action="/admin/edit-topic" method="POST">
        <input type="hidden" id="edit-topic-chapter" name="chapterIndex">
        <input type="hidden" id="edit-topic-index" name="topicIndex">
        <label>New Topic Name:</label>
        <input type="text" id="edit-topic-name" name="newTopicName" placeholder="New topic name" required>
        <button type="submit">Update Topic</button>
      </form>
    </div>
  </div>

  <!-- Delete Topic Modal -->
  <div class="modal" id="delete-topic-modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal('delete-topic-modal')">&times;</span>
      <h3>‚ö†Ô∏è Delete Topic</h3>
      <p style="color: #ff9999; margin-bottom: 20px;">
        Are you sure you want to delete topic "<span id="delete-topic-name"></span>"? 
        This will delete ALL flashcards in this topic!
      </p>
      <form action="/admin/delete-topic" method="POST">
        <input type="hidden" name="chapterIndex" id="delete-topic-chapter">
        <input type="hidden" name="topicIndex" id="delete-topic-index">
        <button type="submit" class="danger">Yes, Delete Topic</button>
        <button type="button" onclick="closeModal('delete-topic-modal')" style="margin-left: 8px;">Cancel</button>
      </form>
    </div>
  </div>
  <!-- View Flashcards Modal -->
  <div class="modal" id="view-flashcards-modal">
    <div class="modal-content" style="max-width: 800px;">
      <span class="close" onclick="closeModal('view-flashcards-modal')">&times;</span>
      <h3 id="flashcards-modal-title">Flashcards</h3>
      <div id="flashcards-list" style="max-height: 500px; overflow-y: auto;"></div>
    </div>
  </div>

  <!-- Edit Flashcard Modal -->
  <div class="modal" id="edit-flashcard-modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal('edit-flashcard-modal')">&times;</span>
      <h3>Edit Flashcard</h3>
      <form id="edit-flashcard-form">
        <input type="hidden" id="edit-flashcard-id">
        <label>Question:</label>
        <textarea id="edit-flashcard-question" required></textarea>
        <label>Answer:</label>
        <textarea id="edit-flashcard-answer" required></textarea>
        <button type="submit">Update Flashcard</button>
      </form>
    </div>
  </div>

  <!-- Delete Flashcard Modal -->
  <div class="modal" id="delete-flashcard-modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal('delete-flashcard-modal')">&times;</span>
      <h3>‚ö†Ô∏è Delete Flashcard</h3>
      <p style="color: #ff9999; margin-bottom: 16px;">Are you sure you want to delete this flashcard?</p>
      <p id="delete-flashcard-preview" style="color: #888; margin-bottom: 20px; font-style: italic;"></p>
      <input type="hidden" id="delete-flashcard-id">
      <button onclick="confirmDeleteFlashcard()" class="danger">Yes, Delete</button>
      <button onclick="closeModal('delete-flashcard-modal')" style="margin-left: 8px;">Cancel</button>
    </div>
  </div>

  <!-- Delete User Modal -->
  <div class="modal" id="delete-user-modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal('delete-user-modal')">&times;</span>
      <h3>‚ö†Ô∏è Delete User</h3>
      <p style="color: #ff9999; margin-bottom: 20px;">
        Are you sure you want to delete user "<span id="delete-user-name"></span>"?
      </p>
      <form action="/admin/delete-user" method="POST">
        <input type="hidden" name="userId" id="delete-user-id">
        <button type="submit" class="danger">Yes, Delete User</button>
        <button type="button" onclick="closeModal('delete-user-modal')" style="margin-left: 8px;">Cancel</button>
      </form>
    </div>
  </div>

  <!-- Subscription Management Modal -->
  <div class="modal" id="subscription-modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal('subscription-modal')">&times;</span>
      <h3>‚≠ê Manage User Subscription</h3>
      <p style="color: #888; margin-bottom: 20px;">
        User: <strong id="sub-username" style="color: #fff;"></strong>
      </p>
      
      <form action="/admin/update-subscription" method="POST">
        <input type="hidden" name="userId" id="sub-userId">
        
        <label>Subscription Status: <span style="color: #ff6b6b;">*</span></label>
        <select name="subscriptionStatus" id="sub-status" required>
          <option value="free">Free</option>
          <option value="premium">Premium</option>
        </select>
        
        <label>Expiry Date (Optional):</label>
        <input type="date" name="subscriptionExpiry" id="sub-expiry" placeholder="YYYY-MM-DD">
        <small style="display: block; margin-top: -10px; margin-bottom: 16px; color: #888;">
          Leave empty for lifetime premium access. Only applies if status is Premium.
        </small>
        
        <button type="submit" style="background: rgba(255,215,0,0.2); border-color: rgba(255,215,0,0.3);">
          ‚≠ê Update Subscription
        </button>
        <button type="button" onclick="closeModal('subscription-modal')" style="margin-left: 8px; background: rgba(255,255,255,0.1);">
          Cancel
        </button>
      </form>
    </div>
  </div>

  <!-- JavaScript -->
  <script>
  // ==================== PREMIUM TOGGLE FUNCTIONS ====================

  function toggleChapterPremium(chapterIndex, isPremium) {
    console.log("üîß Toggle called with:", { chapterIndex, isPremium, type: typeof isPremium });
    
    const action = isPremium ? 'PREMIUM' : 'FREE';
    const confirmation = confirm(
      `Are you sure you want to make Chapter ${chapterIndex} ${action}?\n\n` +
      `This will affect ALL topics and flashcards in this chapter.`
    );
    
    if (!confirmation) return;
    
    showToast('Updating chapter status...', 'info');
    
    console.log("üì§ Sending request:", {
      chapterIndex: parseInt(chapterIndex),
      isPremium: String(isPremium)
    });
    
    fetch('/admin/toggle-chapter-premium', {
      method: 'POST',
      headers: { 
        'Content-Type': 'application/json',
        'Accept': 'application/json'
      },
      body: JSON.stringify({ 
        chapterIndex: parseInt(chapterIndex), 
        isPremium: String(isPremium)
      })
    })
    .then(response => {
      console.log("üì• Response status:", response.status);
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      return response.json();
    })
    .then(data => {
      console.log("‚úÖ Response data:", data);
      if (data.success) {
        showToast(`‚úÖ Chapter ${chapterIndex} is now ${action}!`, 'success');
        setTimeout(() => {
          location.reload();
        }, 1500);
      } else {
        throw new Error('Update failed - success: false');
      }
    })
    .catch(err => {
      console.error('‚ùå Error toggling chapter premium:', err);
      showToast('‚ùå Failed to update chapter status. Check console for details.', 'error');
    });
  }

  function toggleTopicPremium(chapterIndex, topicIndex, isPremium) {
    console.log("üîß Toggle topic called with:", { chapterIndex, topicIndex, isPremium });
    
    const action = isPremium ? 'PREMIUM' : 'FREE';
    const confirmation = confirm(
      `Are you sure you want to make Topic ${topicIndex} ${action}?\n\n` +
      `This will affect ALL flashcards in this topic.`
    );
    
    if (!confirmation) return;
    
    showToast('Updating topic status...', 'info');
    
    fetch('/admin/toggle-topic-premium', {
      method: 'POST',
      headers: { 
        'Content-Type': 'application/json',
        'Accept': 'application/json'
      },
      body: JSON.stringify({ 
        chapterIndex: parseInt(chapterIndex),
        topicIndex: parseInt(topicIndex),
        isPremium: String(isPremium)
      })
    })
    .then(response => {
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      return response.json();
    })
    .then(data => {
      if (data.success) {
        showToast(`‚úÖ Topic ${topicIndex} is now ${action}!`, 'success');
        setTimeout(() => {
          location.reload();
        }, 1500);
      } else {
        throw new Error('Update failed');
      }
    })
    .catch(err => {
      console.error('‚ùå Error toggling topic premium:', err);
      showToast('‚ùå Failed to update topic status. Check console for details.', 'error');
    });
  }

  function openSubscriptionModal(userId, username, currentStatus, currentExpiry) {
    document.getElementById('sub-userId').value = userId;
    document.getElementById('sub-username').textContent = username;
    document.getElementById('sub-status').value = currentStatus || 'free';
    
    if (currentExpiry) {
      const date = new Date(currentExpiry);
      const formattedDate = date.toISOString().split('T')[0];
      document.getElementById('sub-expiry').value = formattedDate;
    } else {
      document.getElementById('sub-expiry').value = '';
    }
    
    openModal('subscription-modal');
  }

  console.log("‚úÖ Premium functions loaded");
  </script>

  <script>
  window.chapters = <%- JSON.stringify(chapters) %>;
  window.topics = <%- JSON.stringify(topics) %>;
  </script>

  <script src="/clientadmin.js"></script>

</body>
</html>

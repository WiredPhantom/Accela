<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Panel</title>
  <link rel="stylesheet" href="/admin.css">
</head>
  
<body>
  <div class="admin-layout">
    <!-- Sidebar Navigation -->
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <h2>ğŸ“š Admin Panel</h2>
      </div>
      <nav>
        <a class="nav-item active" onclick="showSection('dashboard')" data-section="dashboard">
          <span class="icon">ğŸ“Š</span>
          Dashboard
        </a>
        
        <!-- FLASHCARDS SECTION -->
        <div style="margin: 20px 0; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 8px;">
          <div style="color: #888; font-size: 12px; font-weight: 600; margin-bottom: 8px;">FLASHCARDS</div>
          <a class="nav-item" onclick="showSection('chapters')" data-section="chapters">
            <span class="icon">ğŸ“š</span>
            Chapters
          </a>
          <a class="nav-item" onclick="showSection('topics')" data-section="topics">
            <span class="icon">ğŸ“</span>
            Topics
          </a>
          <a class="nav-item" onclick="showSection('flashcards')" data-section="flashcards">
            <span class="icon">ğŸ´</span>
            All Flashcards
          </a>
          <a class="nav-item" onclick="showSection('add-content')" data-section="add-content">
            <span class="icon">â•</span>
            Add Flashcard
          </a>
          <a class="nav-item" onclick="showSection('bulk-upload')" data-section="bulk-upload">
            <span class="icon">ğŸ“¦</span>
            Bulk Upload
          </a>
        </div>

        <!-- NOTES SECTION -->
        <div style="margin: 20px 0; padding: 10px; background: rgba(255,215,0,0.05); border-radius: 8px;">
          <div style="color: #ffd700; font-size: 12px; font-weight: 600; margin-bottom: 8px;">NOTES</div>
          <a class="nav-item" onclick="showSection('notes')" data-section="notes">
            <span class="icon">ğŸ“</span>
            All Notes
          </a>
          <a class="nav-item" onclick="showSection('add-note')" data-section="add-note">
            <span class="icon">â•</span>
            Add Note
          </a>
        </div>

        <a class="nav-item" onclick="showSection('premium')" data-section="premium">
          <span class="icon">â­</span>
          Premium Management
        </a>
        <a class="nav-item" onclick="showSection('users')" data-section="users">
          <span class="icon">ğŸ‘¥</span>
          Users
        </a>
        <!-- NEW: Device Locks Section -->
        <a class="nav-item" onclick="showSection('device-locks')" data-section="device-locks">
          <span class="icon">ğŸ”’</span>
          Device Locks
        </a>
      </nav>
      <div class="sidebar-footer">
        <a href="/" class="home-btn" style="width: 100%; text-align: center; display: block; margin-bottom: 12px;">â† Back to Home</a>
        <form action="/logout" method="GET">
          <button type="submit" class="danger" style="width: 100%;">Logout</button>
        </form>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
      <!-- Search Bar -->
      <div class="search-section">
        <div class="search-bar">
          <input type="text" class="search-input" id="globalSearch" placeholder="ğŸ” Search chapters, topics, flashcards, or notes..." oninput="performSearch()">
          <button onclick="clearSearch()">Clear</button>
        </div>
      </div>

      <!-- Dashboard Section -->
      <div class="section active" id="dashboard-section">
        <div style="max-width: 1200px; margin: 0 auto;">
          <h1 class="title">Dashboard</h1>
          
          <div class="stats-grid">
            <div class="stat-card">
              <div class="icon">ğŸ“š</div>
              <div class="number" id="stat-chapters"><%= chapters.length %></div>
              <div class="label">Flashcard Chapters</div>
            </div>
            <div class="stat-card">
              <div class="icon">ğŸ“</div>
              <div class="number" id="stat-topics"><%= topics.length %></div>
              <div class="label">Flashcard Topics</div>
            </div>
            <div class="stat-card">
              <div class="icon">ğŸ´</div>
              <div class="number" id="stat-flashcards"><span class="loading"></span></div>
              <div class="label">Total Flashcards</div>
            </div>
            <div class="stat-card" style="background: rgba(255,215,0,0.1); border-color: rgba(255,215,0,0.3);">
              <div class="icon">ğŸ“</div>
              <div class="number" id="stat-notes"><%= noteTopics.length %></div>
              <div class="label">Total Notes</div>
            </div>
            <div class="stat-card">
              <div class="icon">ğŸ‘¥</div>
              <div class="number" id="stat-users"><%= users.length %></div>
              <div class="label">Total Users</div>
            </div>
          </div>

          <div class="container">
            <h2>Quick Actions</h2>
            <div class="quick-actions">
              <button onclick="showSection('add-content')">â• Add Flashcard</button>
              <button onclick="showSection('add-note')" style="background: rgba(255,215,0,0.2); border-color: rgba(255,215,0,0.3);">ğŸ“ Add Note</button>
              <button onclick="showSection('bulk-upload')">ğŸ“¦ Bulk Upload</button>
              <button onclick="showSection('premium')">â­ Manage Premium</button>
              <button onclick="exportAllData()">ğŸ“¤ Export All Data</button>
              <button onclick="showSection('users')">ğŸ‘¥ Manage Users</button>
              <button onclick="showSection('device-locks')" style="background: rgba(255,107,107,0.2); border-color: rgba(255,107,107,0.3);">ğŸ”’ Device Locks</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Chapters Section -->
      <div class="section" id="chapters-section">
        <div style="max-width: 1200px; margin: 0 auto;">
          <h1 class="title">Chapters Management</h1>
          <div class="container">
            <table>
              <thead>
                <tr>
                  <th>Index</th>
                  <th>Name</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <% chapters.forEach(ch => { %>
                  <tr>
                    <td>Chapter <%= ch._id %></td>
                    <td><%= ch.chapterName %></td>
                    <td>
                      <button onclick="openEditChapterModal(<%= ch._id %>, '<%= ch.chapterName.replace(/'/g, "\\'") %>')">âœï¸ Edit</button>
                      <button onclick="openDeleteChapterModal(<%= ch._id %>)" class="danger">ğŸ—‘ï¸ Delete</button>
                    </td>
                  </tr>
                <% }) %>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Topics Section -->
      <div class="section" id="topics-section">
        <div style="max-width: 1200px; margin: 0 auto;">
          <h1 class="title">Topics by Chapter</h1>
          <% 
            let currentChapter = null;
            topics.forEach((tp, index) => {
              if (currentChapter !== tp._id.chapterIndex) {
                if (currentChapter !== null) { 
          %>
                  </ul>
                </div>
              </div>
            <% } %>
            
            <div class="container">
              <div class="collapsible-header" onclick="toggleCollapse(this)">
                <h2>Chapter <%= tp._id.chapterIndex %>: <%= tp.chapterName %></h2>
                <span class="collapse-icon">â–¼</span>
              </div>
              <div class="collapsible-content">
                <ul class="topic-list">
          <%
                currentChapter = tp._id.chapterIndex;
              } 
          %>
                  <li class="topic-item">
                    <div>
                      <strong>Topic <%= tp._id.topicIndex %>: <%= tp.topicName %></strong>
                      <span class="card-count" id="count-<%= tp._id.chapterIndex %>-<%= tp._id.topicIndex %>">...</span>
                    </div>
                    <div>
                      <button onclick="viewFlashcards(<%= tp._id.chapterIndex %>, <%= tp._id.topicIndex %>, '<%= tp.topicName.replace(/'/g, "\\'") %>')">ğŸ“‹ View Cards</button>
                      <button onclick="openTopicEditModal('<%= tp._id.chapterIndex %>', '<%= tp._id.topicIndex %>', '<%= tp.topicName.replace(/'/g, "\\'") %>')">âœï¸ Edit</button>
                      <button onclick="openDeleteTopicModal('<%= tp._id.chapterIndex %>', '<%= tp._id.topicIndex %>', '<%= tp.topicName.replace(/'/g, "\\'") %>')" class="danger">ğŸ—‘ï¸ Delete</button>
                    </div>
                  </li>
          <% 
              if (index === topics.length - 1) { 
          %>
                </ul>
              </div>
            </div>
          <% 
              } 
            }) 
          %>
        </div>
      </div>

      <!-- All Flashcards Section -->
      <div class="section" id="flashcards-section">
        <div style="max-width: 1200px; margin: 0 auto;">
          <h1 class="title">All Flashcards</h1>
          <div class="container">
            <div style="margin-bottom: 20px; display: flex; gap: 12px; flex-wrap: wrap;">
              <select id="filterChapter" onchange="filterFlashcards()">
                <option value="">All Chapters</option>
                <% chapters.forEach(ch => { %>
                  <option value="<%= ch._id %>">Chapter <%= ch._id %>: <%= ch.chapterName %></option>
                <% }) %>
              </select>
              <select id="filterTopic" onchange="filterFlashcards()" disabled>
                <option value="">All Topics</option>
              </select>
              <button onclick="loadAllFlashcards()">ğŸ”„ Refresh</button>
            </div>
            <div id="all-flashcards-list">
              <p style="color: #888; text-align: center; padding: 40px;">
                <span class="loading"></span> Loading flashcards...
              </p>
            </div>
          </div>
        </div>
      </div>

      <!-- Add Content Section (Flashcards) -->
      <div class="section" id="add-content-section">
        <div style="max-width: 1200px; margin: 0 auto;">
          <h1 class="title">â• Add Flashcard</h1>
          <div class="container">
            <form action="/admin/add-flashcard" method="POST" id="add-flashcard-form">
              <label>Select Chapter:</label>
              <select id="chapterIndex" name="chapterIndex" onchange="fillChapterName()">
                <option value="">-- Select Chapter --</option>
                <% chapters.forEach(ch => { %>
                  <option value="<%= ch._id %>"><%= ch._id %> â€” <%= ch.chapterName %></option>
                <% }) %>
              </select>
              <input type="text" id="chapterName" name="chapterName" placeholder="Auto-filled chapter name" readonly>

              <label>Or Create New Chapter:</label>
              <input type="text" name="newChapterName" id="newChapterName" placeholder="Enter new chapter name">
              <input type="hidden" name="newChapterIndex" id="newChapterIndex">

              <label>Select Topic:</label>
              <select id="topicIndex" name="topicIndex" onchange="fillTopicName()">
                <option value="">-- Select Topic --</option>
                <% topics.forEach(tp => { %>
                  <option value="<%= tp._id.topicIndex %>" data-chapter="<%= tp._id.chapterIndex %>" data-name="<%= tp.topicName %>">
                    Chapter <%= tp._id.chapterIndex %>, Topic <%= tp._id.topicIndex %> â€” <%= tp.topicName %>
                  </option>
                <% }) %>
              </select>
              <input type="text" id="topicName" name="topicName" placeholder="Auto-filled topic name" readonly>

              <label>Or Create New Topic:</label>
<div style="display: grid; grid-template-columns: 120px 1fr; gap: 12px; align-items: end;">
  <div>
    <label style="font-size: 12px; color: #888; margin-bottom: 4px; display: block;">
      Topic Index:
    </label>
    <input 
      type="number" 
      name="newTopicIndex" 
      id="newTopicIndex" 
      min="1" 
      placeholder="Auto"
      title="Leave empty for auto-numbering or enter a specific number"
      style="text-align: center; font-weight: 600;">
  </div>
  <div>
    <label style="font-size: 12px; color: #888; margin-bottom: 4px; display: block;">
      Topic Name:
    </label>
    <input 
      type="text" 
      name="newTopicName" 
      id="newTopicName" 
      placeholder="Enter new topic name">
  </div>
</div>
<small style="display: block; margin-top: 8px; color: #888; background: rgba(255,255,255,0.03); padding: 8px; border-radius: 6px; border-left: 3px solid #4f46e5;">
  ğŸ’¡ <strong>Auto Mode:</strong> Leave index empty for smart numbering (fills gaps)<br>
  ğŸ¯ <strong>Manual Mode:</strong> Enter a specific number to create Topic 4, 5, 6, etc.
</small>

              <label>Question: <span style="color: #ff6b6b;">*</span></label>
              <textarea name="question" required placeholder="Enter the question here"></textarea>
              
              <label>Answer: <span style="color: #ff6b6b;">*</span></label>
              <textarea name="answer" required placeholder="Enter the answer here"></textarea>

              <label style="display: flex; align-items: center; gap: 8px; margin-top: 16px;">
                <input type="checkbox" name="isPremium" id="isPremium" style="width: auto; margin: 0;">
                <span>ğŸ”’ Mark as Premium Content</span>
              </label>

              <button type="submit" id="submit-flashcard-btn">Add Flashcard</button>
            </form>
          </div>
        </div>
      </div>
<!-- ============= BULK UPLOAD SECTION (UPDATED) ============= -->
<div class="section" id="bulk-upload-section">
  <div style="max-width: 1200px; margin: 0 auto;">
    <h1 class="title">ğŸ“¦ Bulk Upload Flashcards</h1>
    <div class="container">
      <form action="/admin/bulk-upload" method="POST" id="bulk-upload-form" enctype="multipart/form-data">
        <label>Select Chapter:</label>
        <select id="bulkChapterIndex" name="chapterIndex" onchange="fillBulkChapterName()">
          <option value="">-- Select Chapter --</option>
          <% chapters.forEach(ch => { %>
            <option value="<%= ch._id %>"><%= ch._id %> â€” <%= ch.chapterName %></option>
          <% }) %>
        </select>
        <input type="text" name="chapterName" id="bulkChapterName" readonly placeholder="Auto-filled chapter name">

        <label>Or Create New Chapter:</label>
        <input type="text" name="newChapterName" id="bulknewChapterName" placeholder="Enter new chapter name">
        <input type="hidden" name="newChapterIndex" id="bulknewChapterIndex">

        <label>Select Topic:</label>
        <select id="bulkTopicIndex" name="topicIndex" onchange="fillBulkTopicName()">
          <option value="">-- Select Topic --</option>
          <% topics.forEach(tp => { %>
            <option value="<%= tp._id.topicIndex %>" data-chapter="<%= tp._id.chapterIndex %>" data-name="<%= tp.topicName %>">
              Chapter <%= tp._id.chapterIndex %>, Topic <%= tp._id.topicIndex %> â€” <%= tp.topicName %>
            </option>
          <% }) %>
        </select>
        <input type="text" name="topicName" id="bulkTopicName" readonly placeholder="Auto-filled topic name">

        <label>Or Create New Topic:</label>
<div style="display: grid; grid-template-columns: 120px 1fr; gap: 12px; align-items: end;">
  <div>
    <label style="font-size: 12px; color: #888; margin-bottom: 4px; display: block;">
      Topic Index:
    </label>
    <input 
      type="number" 
      name="newTopicIndex" 
      id="bulknewTopicIndex" 
      min="1" 
      placeholder="Auto"
      title="Leave empty for auto-numbering"
      style="text-align: center; font-weight: 600;">
  </div>
  <div>
    <label style="font-size: 12px; color: #888; margin-bottom: 4px; display: block;">
      Topic Name:
    </label>
    <input 
      type="text" 
      name="newTopicName" 
      id="bulknewTopicName" 
      placeholder="Enter new topic name">
  </div>
</div>
<small style="display: block; margin-top: 8px; color: #888; background: rgba(255,255,255,0.03); padding: 8px; border-radius: 6px; border-left: 3px solid #4f46e5;">
  ğŸ’¡ Leave index empty for smart auto-numbering
</small>


        <!-- ============= UPLOAD METHOD TOGGLE ============= -->
        <div style="margin: 24px 0; padding: 16px; background: rgba(255,255,255,0.05); border-radius: 12px; border: 1px solid rgba(255,255,255,0.1);">
          <label style="font-size: 16px; font-weight: 600; margin-bottom: 12px; display: block;">Upload Method:</label>
          <div style="display: flex; gap: 16px; margin-bottom: 16px;">
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; flex: 1; padding: 12px; background: rgba(79,70,229,0.2); border: 2px solid rgba(79,70,229,0.5); border-radius: 8px; transition: all 0.3s;">
              <input type="radio" name="bulkUploadMethod" value="file" id="bulkMethodFile" checked style="width: auto; margin: 0;">
              <span style="font-weight: 500;">ğŸ“ Upload JSON File</span>
            </label>
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; flex: 1; padding: 12px; background: rgba(255,255,255,0.05); border: 2px solid rgba(255,255,255,0.2); border-radius: 8px; transition: all 0.3s;">
              <input type="radio" name="bulkUploadMethod" value="text" id="bulkMethodText" style="width: auto; margin: 0;">
              <span style="font-weight: 500;">âœï¸ Paste JSON Text</span>
            </label>
          </div>

          <!-- FILE UPLOAD SECTION -->
          <div id="bulkFileUploadSection">
            <label>Upload JSON File: <span style="color: #ff6b6b;">*</span></label>
            <input type="file" name="jsonFile" id="bulkJsonFile" accept=".json,application/json" style="padding: 12px; background: rgba(0,0,0,0.3); border: 2px dashed rgba(79,70,229,0.5); cursor: pointer;">
            <small style="display: block; margin-top: -10px; margin-bottom: 16px; color: #888;">
              ğŸ“„ Upload a .json file with flashcard data
            </small>
            <div id="bulkFilePreview" style="display: none; margin-top: 12px; padding: 12px; background: rgba(0,255,136,0.1); border-left: 3px solid #00ff88; border-radius: 8px;">
              <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                <span style="font-size: 20px;">âœ…</span>
                <strong id="bulkFileName" style="color: #00ff88;"></strong>
              </div>
              <small id="bulkFileInfo" style="color: #888;"></small>
            </div>
          </div>

          <!-- TEXT PASTE SECTION -->
          <div id="bulkTextUploadSection" style="display: none;">
            <label>Paste JSON Data: <span style="color: #ff6b6b;">*</span></label>
            <textarea name="jsonData" id="bulkJsonData" placeholder='[{"question": "Q1", "answer": "A1"}, {"question": "Q2", "answer": "A2"}]' style="min-height: 250px; font-family: monospace;"></textarea>
            <small style="display: block; margin-top: -10px; margin-bottom: 16px; color: #888;">
              Format: Array of objects with "question" and "answer" keys. Example shown above.
            </small>
          </div>
        </div>

        <label style="display: flex; align-items: center; gap: 8px; margin-top: 16px;">
          <input type="checkbox" name="isPremium" id="bulkIsPremium" style="width: auto; margin: 0;">
          <span>ğŸ”’ Mark ALL uploaded flashcards as Premium</span>
        </label>

        <button type="submit" id="bulk-submit-btn">Upload Flashcards</button>
      </form>
    </div>
  </div>
          </div>
            

      <!-- ============= NOTES SECTIONS ============= -->

      <!-- All Notes Section -->
      <div class="section" id="notes-section">
        <div style="max-width: 1200px; margin: 0 auto;">
          <h1 class="title">ğŸ“ All Notes</h1>
          <div class="container">
            <div style="margin-bottom: 20px; display: flex; gap: 12px; flex-wrap: wrap;">
              <select id="filterNoteChapter" onchange="filterNotes()">
                <option value="">All Chapters</option>
                <% noteChapters.forEach(ch => { %>
                  <option value="<%= ch._id %>">Chapter <%= ch._id %>: <%= ch.chapterName %></option>
                <% }) %>
              </select>
              <button onclick="loadAllNotes()">ğŸ”„ Refresh</button>
            </div>
            <div id="all-notes-list">
              <p style="color: #888; text-align: center; padding: 40px;">
                <span class="loading"></span> Loading notes...
              </p>
            </div>
          </div>
        </div>
      </div>



                  <!-- ============= ADD NOTE SECTION (UPDATED) ============= -->
<div class="section" id="add-note-section">
  <div style="max-width: 1200px; margin: 0 auto;">
    <h1 class="title">ğŸ“ Add New Note</h1>
    <div class="container">
      <form action="/admin/add-note" method="POST" id="add-note-form" enctype="multipart/form-data">
        <label>Select Chapter:</label>
        <select id="noteChapterIndex" name="chapterIndex" onchange="fillNoteChapterName()">
          <option value="">-- Select Chapter --</option>
          <% noteChapters.forEach(ch => { %>
            <option value="<%= ch._id %>"><%= ch._id %> â€” <%= ch.chapterName %></option>
          <% }) %>
        </select>
        <input type="text" id="noteChapterName" name="chapterName" placeholder="Auto-filled chapter name" readonly>

        <label>Or Create New Chapter:</label>
        <input type="text" name="newChapterName" id="noteNewChapterName" placeholder="Enter new chapter name">
        <input type="hidden" name="newChapterIndex" id="noteNewChapterIndex">

        <label>Select Topic:</label>
        <select id="noteTopicIndex" name="topicIndex" onchange="fillNoteTopicName()">
          <option value="">-- Select Topic --</option>
          <% noteTopics.forEach(tp => { %>
            <option value="<%= tp._id.topicIndex %>" data-chapter="<%= tp._id.chapterIndex %>" data-name="<%= tp.topicName %>">
              Chapter <%= tp._id.chapterIndex %>, Topic <%= tp._id.topicIndex %> â€” <%= tp.topicName %>
            </option>
          <% }) %>
        </select>
        <input type="text" id="noteTopicName" name="topicName" placeholder="Auto-filled topic name" readonly>

        <label>Or Create New Topic:</label>
<div style="display: grid; grid-template-columns: 120px 1fr; gap: 12px; align-items: end;">
  <div>
    <label style="font-size: 12px; color: #ffd700; margin-bottom: 4px; display: block;">
      Topic Index:
    </label>
    <input 
      type="number" 
      name="newTopicIndex" 
      id="noteNewTopicIndex" 
      min="1" 
      placeholder="Auto"
      title="Leave empty for auto-numbering"
      style="text-align: center; font-weight: 600; border-color: rgba(255,215,0,0.3);">
  </div>
  <div>
    <label style="font-size: 12px; color: #ffd700; margin-bottom: 4px; display: block;">
      Topic Name:
    </label>
    <input 
      type="text" 
      name="newTopicName" 
      id="noteNewTopicName" 
      placeholder="Enter new topic name">
  </div>
</div>
<small style="display: block; margin-top: 8px; color: #888; background: rgba(255,215,0,0.03); padding: 8px; border-radius: 6px; border-left: 3px solid #ffd700;">
  ğŸ’¡ Leave index empty for smart auto-numbering
</small>
        <label>Note Title: <span style="color: #ff6b6b;">*</span></label>
        <input type="text" name="noteTitle" id="noteTitle" required placeholder="e.g., ÛÙ†Ø¯ÛŒ Ø·Ø¨ - Ø¢ÛŒÙˆØ±ÙˆÛŒØ¯">

        <!-- ============= UPLOAD METHOD TOGGLE ============= -->
        <div style="margin: 24px 0; padding: 16px; background: rgba(255,215,0,0.05); border-radius: 12px; border: 1px solid rgba(255,215,0,0.2);">
          <label style="font-size: 16px; font-weight: 600; margin-bottom: 12px; display: block;">Upload Method:</label>
          <div style="display: flex; gap: 16px; margin-bottom: 16px;">
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; flex: 1; padding: 12px; background: rgba(255,215,0,0.2); border: 2px solid rgba(255,215,0,0.5); border-radius: 8px; transition: all 0.3s;">
              <input type="radio" name="noteUploadMethod" value="file" id="noteMethodFile" checked style="width: auto; margin: 0;">
              <span style="font-weight: 500;">ğŸ“ Upload HTML File</span>
            </label>
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; flex: 1; padding: 12px; background: rgba(255,255,255,0.05); border: 2px solid rgba(255,255,255,0.2); border-radius: 8px; transition: all 0.3s;">
              <input type="radio" name="noteUploadMethod" value="text" id="noteMethodText" style="width: auto; margin: 0;">
              <span style="font-weight: 500;">âœï¸ Paste HTML Text</span>
            </label>
          </div>

          <!-- FILE UPLOAD SECTION -->
          <div id="noteFileUploadSection">
            <label>Upload HTML File: <span style="color: #ff6b6b;">*</span></label>
            <input type="file" name="htmlFile" id="noteHtmlFile" accept=".html,.htm,text/html" style="padding: 12px; background: rgba(0,0,0,0.3); border: 2px dashed rgba(255,215,0,0.5); cursor: pointer;">
            <small style="display: block; margin-top: -10px; margin-bottom: 16px; color: #888;">
              ğŸ“„ Upload a .html file with your note content
            </small>
            <div id="noteFilePreview" style="display: none; margin-top: 12px; padding: 12px; background: rgba(0,255,136,0.1); border-left: 3px solid #00ff88; border-radius: 8px;">
              <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                <span style="font-size: 20px;">âœ…</span>
                <strong id="noteFileName" style="color: #00ff88;"></strong>
              </div>
              <small id="noteFileInfo" style="color: #888;"></small>
            </div>
          </div>

          <!-- TEXT PASTE SECTION -->
          <div id="noteTextUploadSection" style="display: none;">
            <label>HTML Content: <span style="color: #ff6b6b;">*</span></label>
            <textarea name="htmlContent" id="noteHtmlContent" placeholder="Paste your complete HTML here (including <!DOCTYPE html>, <html>, <head>, <body>, etc.)" style="min-height: 400px; font-family: monospace;"></textarea>
            <small style="display: block; margin-top: -10px; margin-bottom: 16px; color: #888;">
              ğŸ’¡ Tip: Paste your entire HTML file content here. It will be displayed as-is to users.
            </small>
          </div>
        </div>

        <label style="display: flex; align-items: center; gap: 8px; margin-top: 16px;">
          <input type="checkbox" name="isPremium" id="noteIsPremium" style="width: auto; margin: 0;">
          <span>ğŸ”’ Mark as Premium Content</span>
        </label>

        <button type="submit" id="note-submit-btn">Add Note</button>
      </form>
    </div>
  </div>
</div>

      <!-- Premium Management Section -->
      <div class="section" id="premium-section">
        <div style="max-width: 1200px; margin: 0 auto;">
          <h1 class="title">â­ Premium Management</h1>
                    <!-- Manage Chapter Premium Status -->
          <div class="container">
            <h2>Flashcard Chapter Premium Status</h2>
            <p style="color: #888; margin-bottom: 20px;">
              Toggle flashcard chapters between Free and Premium. When you mark a chapter as premium, 
              ALL topics and flashcards in that chapter become premium.
            </p>
            <table>
              <thead>
                <tr>
                  <th>Chapter</th>
                  <th>Name</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <% chapters.forEach(ch => { %>
                  <tr>
                    <td>Chapter <%= ch._id %></td>
                    <td><%= ch.chapterName %></td>
                    <td>
                      <% if (ch.isPremium) { %>
                        <span style="color: #ffd700; font-weight: 600;">ğŸ”’ Premium</span>
                      <% } else { %>
                        <span style="color: #00ff88; font-weight: 600;">ğŸ”“ Free</span>
                      <% } %>
                    </td>
                    <td>
                      <% if (ch.isPremium) { %>
                        <button 
                          onclick="toggleChapterPremium(<%= ch._id %>, false)" 
                          style="background: rgba(0,255,136,0.2); border-color: rgba(0,255,136,0.3);">
                          ğŸ”“ Make Free
                        </button>
                      <% } else { %>
                        <button 
                          onclick="toggleChapterPremium(<%= ch._id %>, true)" 
                          style="background: rgba(255,215,0,0.2); border-color: rgba(255,215,0,0.3);">
                          ğŸ”’ Make Premium
                        </button>
                      <% } %>
                    </td>
                  </tr>
                <% }) %>
              </tbody>
            </table>
          </div>

          <!-- Manage Notes Chapter Premium Status -->
          <div class="container">
            <h2>Notes Chapter Premium Status</h2>
            <p style="color: #888; margin-bottom: 20px;">
              Toggle note chapters between Free and Premium.
            </p>
            <table>
              <thead>
                <tr>
                  <th>Chapter</th>
                  <th>Name</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <% if (noteChapters.length === 0) { %>
                  <tr>
                    <td colspan="4" style="text-align: center; color: #888;">No note chapters yet</td>
                  </tr>
                <% } else { %>
                  <% noteChapters.forEach(ch => { %>
                    <tr>
                      <td>Chapter <%= ch._id %></td>
                      <td><%= ch.chapterName %></td>
                      <td>
                        <% if (ch.isPremium) { %>
                          <span style="color: #ffd700; font-weight: 600;">ğŸ”’ Premium</span>
                        <% } else { %>
                          <span style="color: #00ff88; font-weight: 600;">ğŸ”“ Free</span>
                        <% } %>
                      </td>
                      <td>
                        <% if (ch.isPremium) { %>
                          <button 
                            onclick="toggleNoteChapterPremium(<%= ch._id %>, false)" 
                            style="background: rgba(0,255,136,0.2); border-color: rgba(0,255,136,0.3);">
                            ğŸ”“ Make Free
                          </button>
                        <% } else { %>
                          <button 
                            onclick="toggleNoteChapterPremium(<%= ch._id %>, true)" 
                            style="background: rgba(255,215,0,0.2); border-color: rgba(255,215,0,0.3);">
                            ğŸ”’ Make Premium
                          </button>
                        <% } %>
                      </td>
                    </tr>
                  <% }) %>
                <% } %>
              </tbody>
            </table>
          </div>

          <!-- Manage Topic Premium Status -->
          <div class="container">
            <h2>Flashcard Topic Premium Status (By Chapter)</h2>
            <p style="color: #888; margin-bottom: 20px;">
              Toggle individual topics between Free and Premium. 
              This affects all flashcards within the topic.
            </p>
            
            <% 
              let premiumCurrentChapter = null;
              topics.forEach((tp, index) => {
                if (premiumCurrentChapter !== tp._id.chapterIndex) {
                  if (premiumCurrentChapter !== null) { 
            %>
                    </tbody>
                  </table>
                </div>
              </div>
            <% } %>
            
            <div style="background: rgba(255, 255, 255, 0.03); border-radius: 12px; padding: 20px; margin-bottom: 20px;">
              <div class="collapsible-header" onclick="toggleCollapse(this)">
                <h3>Chapter <%= tp._id.chapterIndex %>: <%= tp.chapterName %></h3>
                <span class="collapse-icon">â–¼</span>
              </div>
              <div class="collapsible-content">
                <table style="margin-top: 16px;">
                  <thead>
                    <tr>
                      <th>Topic</th>
                      <th>Name</th>
                      <th>Status</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody>
            <%
                  premiumCurrentChapter = tp._id.chapterIndex;
                } 
            %>
                    <tr>
                      <td>Topic <%= tp._id.topicIndex %></td>
                      <td><%= tp.topicName %></td>
                      <td>
                        <% if (tp.isPremium) { %>
                          <span style="color: #ffd700; font-weight: 600;">ğŸ”’ Premium</span>
                        <% } else { %>
                          <span style="color: #00ff88; font-weight: 600;">ğŸ”“ Free</span>
                        <% } %>
                      </td>
                      <td>
                        <% if (tp.isPremium) { %>
                          <button 
                            onclick="toggleTopicPremium(<%= tp._id.chapterIndex %>, <%= tp._id.topicIndex %>, false)" 
                            style="background: rgba(0,255,136,0.2); border-color: rgba(0,255,136,0.3);">
                            ğŸ”“ Make Free
                          </button>
                        <% } else { %>
                          <button 
                            onclick="toggleTopicPremium(<%= tp._id.chapterIndex %>, <%= tp._id.topicIndex %>, true)" 
                            style="background: rgba(255,215,0,0.2); border-color: rgba(255,215,0,0.3);">
                            ğŸ”’ Make Premium
                          </button>
                        <% } %>
                      </td>
                    </tr>
            <% 
                if (index === topics.length - 1) { 
            %>
                  </tbody>
                </table>
              </div>
            </div>
                 <% 
                } 
              }) 
            %>
          </div>

          <!-- Manage User Subscriptions -->
          <div class="container">
            <h2>User Subscriptions</h2>
            <p style="color: #888; margin-bottom: 20px;">
              Manage user subscription status and expiry dates. Admins automatically have full access.
            </p>
            <table>
              <thead>
                <tr>
                  <th>User ID</th>
                  <th>Username</th>
                  <th>Role</th>
                  <th>Subscription</th>
                  <th>Expiry</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <% users.forEach(user => { %>
                  <tr>
                    <td><%= user.userId %></td>
                    <td><%= user.username %></td>
                    <td style="text-transform: capitalize;">
                      <% if (user.role === 'admin') { %>
                        <span style="color: #ff6b9d;">ğŸ‘‘ <%= user.role %></span>
                      <% } else { %>
                        <%= user.role %>
                      <% } %>
                    </td>
                    <td>
                      <% if (user.subscriptionStatus === 'premium') { %>
                        <span style="color: #ffd700; font-weight: 600;">â­ Premium</span>
                      <% } else { %>
                        <span style="color: #888;">Free</span>
                      <% } %>
                    </td>
                    <td>
                      <% if (user.subscriptionExpiry) { %>
                        <%= new Date(user.subscriptionExpiry).toLocaleDateString() %>
                      <% } else if (user.subscriptionStatus === 'premium') { %>
                        <span style="color: #00ff88;">Lifetime</span>
                      <% } else { %>
                        -
                      <% } %>
                    </td>
                    <td>
                      <button onclick="openSubscriptionModal('<%= user.userId %>', '<%= user.username.replace(/'/g, "\\'") %>', '<%= user.subscriptionStatus %>', '<%= user.subscriptionExpiry || "" %>')">
                        âœï¸ Manage
                      </button>
                    </td>
                  </tr>
                <% }) %>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Users Section -->
      <div class="section" id="users-section">
        <div style="max-width: 1200px; margin: 0 auto;">
          <h1 class="title">ğŸ‘¥ User Management</h1>
          
          <div class="container">
            <h2>Current Users</h2>
            <table>
              <thead>
                <tr>
                  <th>User ID</th>
                  <th>Username</th>
                  <th>Role</th>
                  <th>Subscription</th>
                  <th>Device Lock</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <% users.forEach(user => { %>
                  <tr>
                    <td><%= user.userId %></td>
                    <td><%= user.username %></td>
                    <td><span style="text-transform: capitalize;"><%= user.role %></span></td>
                    <td>
                      <% if (user.subscriptionStatus === 'premium') { %>
                        <span style="color: #ffd700;">â­ Premium</span>
                      <% } else { %>
                        <span style="color: #888;">Free</span>
                      <% } %>
                    </td>
                    <td>
                      <% if (user.deviceLock && user.deviceLock.deviceFingerprint && user.deviceLock.expiresAt > new Date()) { %>
                        <span style="color: #ff6b6b;">ğŸ”’ Locked</span>
                        <br><small style="color: #888;">Expires: <%= new Date(user.deviceLock.expiresAt).toLocaleDateString() %></small>
                      <% } else { %>
                        <span style="color: #00ff88;">ğŸ”“ None</span>
                      <% } %>
                    </td>
                    <td>
                      <button onclick="forceLogout('<%= user.userId %>', '<%= user.username.replace(/'/g, "\\'") %>')">ğŸšª Force Logout</button>
                      <% if (user.deviceLock && user.deviceLock.deviceFingerprint && user.deviceLock.expiresAt > new Date()) { %>
                        <button onclick="clearDeviceLock('<%= user.userId %>', '<%= user.username.replace(/'/g, "\\'") %>')" style="background: rgba(255,165,0,0.2); border-color: rgba(255,165,0,0.3);">ğŸ”“ Clear Lock</button>
                      <% } %>
                      <button onclick="openDeleteUserModal('<%= user.userId %>', '<%= user.username.replace(/'/g, "\\'") %>')" class="danger">ğŸ—‘ï¸ Delete</button>
                    </td>
                  </tr>
                <% }) %>
              </tbody>
            </table>
          </div>

          <div class="container">
            <h2>â• Add New User</h2>
            <form action="/admin/add-user" method="POST">
              <label>User ID: <span style="color: #ff6b6b;">*</span></label>
              <input type="text" name="userId" required placeholder="Enter unique user ID">

              <label>Username: <span style="color: #ff6b6b;">*</span></label>
              <input type="text" name="username" required placeholder="Enter username">

              <label>Password: <span style="color: #ff6b6b;">*</span></label>
              <input type="password" name="password" required placeholder="Enter password">

              <label>Role: <span style="color: #ff6b6b;">*</span></label>
              <select name="role" required>
                <option value="user">User</option>
                <option value="admin">Admin</option>
              </select>

              <label>Subscription Status:</label>
              <select name="subscriptionStatus">
                <option value="free">Free</option>
                <option value="premium">Premium</option>
              </select>

              <button type="submit">Add User</button>
            </form>
          </div>
        </div>
      </div>

      <!-- ==================== NEW: DEVICE LOCKS SECTION ==================== -->
      <div class="section" id="device-locks-section">
        <div style="max-width: 1200px; margin: 0 auto;">
          <h1 class="title">ğŸ”’ Device Lock Management</h1>
          
          <div class="container">
            <div style="background: rgba(255,107,107,0.1); border: 1px solid rgba(255,107,107,0.3); border-radius: 12px; padding: 16px; margin-bottom: 20px;">
              <h3 style="color: #ff6b6b; margin-bottom: 8px;">â„¹ï¸ How Device Locks Work</h3>
              <ul style="color: #ccc; font-size: 14px; line-height: 1.8; padding-left: 20px;">
                <li><strong>Premium users</strong> are locked to one device for 30 days after login</li>
                <li><strong>Free users</strong> have NO device lock â€” they can login from anywhere</li>
                <li><strong>Admins</strong> are exempt from all device locks</li>
                <li>Device lock <strong>persists after logout</strong> â€” logging out doesn't clear the lock</li>
                <li>Only <strong>you (admin)</strong> can manually clear a device lock, or it expires after 30 days</li>
              </ul>
            </div>

            <div style="display: flex; gap: 12px; margin-bottom: 20px;">
              <button onclick="loadDeviceLocks()">ğŸ”„ Refresh Locks</button>
              <button onclick="loadActiveSessions()">ğŸ“Š View Active Sessions</button>
            </div>

            <h2>Active Device Locks</h2>
            <div id="device-locks-list">
              <p style="color: #888; text-align: center; padding: 40px;">
                Click "Refresh Locks" to load active device locks
              </p>
            </div>
          </div>

          <div class="container">
            <h2>Active Sessions</h2>
            <div id="active-sessions-list">
              <p style="color: #888; text-align: center; padding: 40px;">
                Click "View Active Sessions" to load
              </p>
            </div>
          </div>

          <div class="container">
            <h2>ğŸ”“ Quick Clear Device Lock</h2>
            <p style="color: #888; margin-bottom: 16px;">
              Enter a username to quickly clear their device lock. Use this when a user contacts you saying they bought a new phone.
            </p>
            <div style="display: flex; gap: 12px; align-items: end;">
              <div style="flex: 1;">
                <label>Username:</label>
                <input type="text" id="quickClearUsername" placeholder="Enter username" style="margin-bottom: 0;">
              </div>
              <button onclick="quickClearDeviceLock()" style="background: rgba(255,165,0,0.2); border-color: rgba(255,165,0,0.3); white-space: nowrap; margin-bottom: 0;">
                ğŸ”“ Clear Lock
              </button>
            </div>
          </div>
        </div>
      </div>

    </main>
  </div>

  <!-- Mobile Menu Button -->
  <button class="mobile-menu-btn" onclick="toggleMobileMenu()">â˜°</button>

  <!-- Toast Container -->
  <div id="toast-container"></div>

  <!-- ========== MODALS ========== -->
  
  <!-- Edit Chapter Modal -->
  <div class="modal" id="edit-chapter-modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal('edit-chapter-modal')">&times;</span>
      <h3>Edit Chapter Name</h3>
      <form action="/admin/edit-chapter" method="POST">
        <input type="hidden" name="oldChapterIndex" id="edit-old-chapter-index">
        <label>New Chapter Name:</label>
        <input type="text" name="newChapterName" id="edit-new-chapter-name" placeholder="New chapter name" required>
        <button type="submit">Update Chapter</button>
      </form>
    </div>
  </div>

  <!-- Delete Chapter Modal -->
  <div class="modal" id="delete-chapter-modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal('delete-chapter-modal')">&times;</span>
      <h3>âš ï¸ Delete Chapter</h3>
      <p style="color: #ff9999; margin-bottom: 20px;">
        Are you sure you want to delete Chapter <span id="delete-chapter-number"></span>? 
        This will delete ALL topics and flashcards in this chapter!
      </p>
      <form action="/admin/delete-chapter" method="POST">
        <input type="hidden" name="chapterIndex" id="delete-chapter-index">
        <button type="submit" class="danger">Yes, Delete Chapter</button>
        <button type="button" onclick="closeModal('delete-chapter-modal')" style="margin-left: 8px;">Cancel</button>
      </form>
    </div>
  </div>

  <!-- Edit Topic Modal -->
  <div class="modal" id="edit-topic-modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal('edit-topic-modal')">&times;</span>
      <h3>Edit Topic Name</h3>
      <form action="/admin/edit-topic" method="POST">
        <input type="hidden" id="edit-topic-chapter" name="chapterIndex">
        <input type="hidden" id="edit-topic-index" name="topicIndex">
        <label>New Topic Name:</label>
        <input type="text" id="edit-topic-name" name="newTopicName" placeholder="New topic name" required>
        <button type="submit">Update Topic</button>
      </form>
    </div>
  </div>

  <!-- Delete Topic Modal -->
  <div class="modal" id="delete-topic-modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal('delete-topic-modal')">&times;</span>
      <h3>âš ï¸ Delete Topic</h3>
      <p style="color: #ff9999; margin-bottom: 20px;">
        Are you sure you want to delete topic "<span id="delete-topic-name"></span>"? 
        This will delete ALL flashcards in this topic!
      </p>
      <form action="/admin/delete-topic" method="POST">
        <input type="hidden" name="chapterIndex" id="delete-topic-chapter">
        <input type="hidden" name="topicIndex" id="delete-topic-index">
        <button type="submit" class="danger">Yes, Delete Topic</button>
        <button type="button" onclick="closeModal('delete-topic-modal')" style="margin-left: 8px;">Cancel</button>
      </form>
    </div>
  </div>

  <!-- View Flashcards Modal -->
  <div class="modal" id="view-flashcards-modal">
    <div class="modal-content" style="max-width: 800px;">
      <span class="close" onclick="closeModal('view-flashcards-modal')">&times;</span>
      <h3 id="flashcards-modal-title">Flashcards</h3>
      <div id="flashcards-list" style="max-height: 500px; overflow-y: auto;"></div>
    </div>
  </div>

  <!-- Edit Flashcard Modal -->
  <div class="modal" id="edit-flashcard-modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal('edit-flashcard-modal')">&times;</span>
      <h3>Edit Flashcard</h3>
      <form id="edit-flashcard-form">
        <input type="hidden" id="edit-flashcard-id">
        <label>Question:</label>
        <textarea id="edit-flashcard-question" required></textarea>
        <label>Answer:</label>
        <textarea id="edit-flashcard-answer" required></textarea>
        <button type="submit">Update Flashcard</button>
      </form>
    </div>
  </div>

  <!-- Delete Flashcard Modal -->
  <div class="modal" id="delete-flashcard-modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal('delete-flashcard-modal')">&times;</span>
      <h3>âš ï¸ Delete Flashcard</h3>
      <p style="color: #ff9999; margin-bottom: 16px;">Are you sure you want to delete this flashcard?</p>
      <p id="delete-flashcard-preview" style="color: #888; margin-bottom: 20px; font-style: italic;"></p>
      <input type="hidden" id="delete-flashcard-id">
      <button onclick="confirmDeleteFlashcard()" class="danger">Yes, Delete</button>
      <button onclick="closeModal('delete-flashcard-modal')" style="margin-left: 8px;">Cancel</button>
    </div>
  </div>

  <!-- Edit Note Modal -->
  <div class="modal" id="edit-note-modal">
    <div class="modal-content" style="max-width: 900px;">
      <span class="close" onclick="closeModal('edit-note-modal')">&times;</span>
      <h3>Edit Note</h3>
      <form id="edit-note-form">
        <input type="hidden" id="edit-note-id">
        
        <label>Note Title:</label>
        <input type="text" id="edit-note-title" required placeholder="Note title">
        
        <label>HTML Content:</label>
        <textarea id="edit-note-content" required style="min-height: 400px; font-family: monospace;" placeholder="Paste HTML content here"></textarea>
        
        <label style="display: flex; align-items: center; gap: 8px; margin-top: 16px;">
          <input type="checkbox" id="edit-note-premium" style="width: auto; margin: 0;">
          <span>ğŸ”’ Mark as Premium Content</span>
        </label>
        
        <button type="submit">Update Note</button>
      </form>
    </div>
  </div>

  <!-- Delete Note Modal -->
  <div class="modal" id="delete-note-modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal('delete-note-modal')">&times;</span>
      <h3>âš ï¸ Delete Note</h3>
      <p style="color: #ff9999; margin-bottom: 16px;">Are you sure you want to delete this note?</p>
      <p id="delete-note-preview" style="color: #888; margin-bottom: 20px; font-style: italic;"></p>
      <input type="hidden" id="delete-note-id">
      <button onclick="confirmDeleteNote()" class="danger">Yes, Delete</button>
      <button onclick="closeModal('delete-note-modal')" style="margin-left: 8px;">Cancel</button>
    </div>
  </div>

  <!-- Delete User Modal -->
  <div class="modal" id="delete-user-modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal('delete-user-modal')">&times;</span>
      <h3>âš ï¸ Delete User</h3>
      <p style="color: #ff9999; margin-bottom: 20px;">
        Are you sure you want to delete user "<span id="delete-user-name"></span>"?
      </p>
      <form action="/admin/delete-user" method="POST">
        <input type="hidden" name="userId" id="delete-user-id">
        <button type="submit" class="danger">Yes, Delete User</button>
        <button type="button" onclick="closeModal('delete-user-modal')" style="margin-left: 8px;">Cancel</button>
      </form>
    </div>
  </div>

  <!-- Subscription Management Modal -->
  <div class="modal" id="subscription-modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal('subscription-modal')">&times;</span>
      <h3>â­ Manage User Subscription</h3>
      <p style="color: #888; margin-bottom: 20px;">
        User: <strong id="sub-username" style="color: #fff;"></strong>
      </p>
      
      <form action="/admin/update-subscription" method="POST">
        <input type="hidden" name="userId" id="sub-userId">
        
        <label>Subscription Status: <span style="color: #ff6b6b;">*</span></label>
        <select name="subscriptionStatus" id="sub-status" required>
          <option value="free">Free</option>
          <option value="premium">Premium</option>
        </select>
        
        <label>Expiry Date (Optional):</label>
        <input type="date" name="subscriptionExpiry" id="sub-expiry" placeholder="YYYY-MM-DD">
        <small style="display: block; margin-top: -10px; margin-bottom: 16px; color: #888;">
          Leave empty for lifetime premium access. Only applies if status is Premium.
          <br>âš ï¸ Downgrading to Free will also clear the user's device lock.
        </small>
        
        <button type="submit" style="background: rgba(255,215,0,0.2); border-color: rgba(255,215,0,0.3);">
          â­ Update Subscription
        </button>
        <button type="button" onclick="closeModal('subscription-modal')" style="margin-left: 8px; background: rgba(255,255,255,0.1);">
          Cancel
        </button>
      </form>
    </div>
  </div>

  <!-- JavaScript -->
  <script>
  window.chapters = <%- JSON.stringify(chapters) %>;
  window.topics = <%- JSON.stringify(topics) %>;
  window.noteChapters = <%- JSON.stringify(noteChapters) %>;
  window.noteTopics = <%- JSON.stringify(noteTopics) %>;
 // ADD THIS HELPER FUNCTION:
function findNextAvailableIndex(existingIndices) {
  if (existingIndices.length === 0) return 1;
  const sorted = [...existingIndices].sort((a, b) => a - b);
  for (let i = 0; i < sorted.length; i++) {
    if (sorted[i] !== i + 1) return i + 1;
  }
  return sorted[sorted.length - 1] + 1;
}
</script>

  <script src="/clientadmin.js"></script>

</body>
</html>
